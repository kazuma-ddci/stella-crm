# /deep コマンド

厳密実装モードに切り替えます。

## 動作

### 引数なしで実行された場合

```
要望を入力してください。
```

### ユーザーが要望を入力した後のフロー

以下の順序で必ず実行すること：

#### 1. 要望の分解

ユーザーの要望を具体的なタスクに分解する。

```markdown
## 要望の分解

1. [タスク1]
2. [タスク2]
3. ...
```

#### 2. 影響ファイル候補の列挙

変更が必要と思われるファイルを理由付きで列挙する。

```markdown
## 影響ファイル候補

| ファイル | 変更理由 |
|---------|---------|
| `path/to/file1.tsx` | [理由] |
| `path/to/file2.ts` | [理由] |
```

#### 3. 確定仕様の確認

各候補ファイルに対して `/check-specs` 相当のチェックを実施する。

```markdown
## 確定仕様チェック

### `path/to/file1.tsx`

関連SPEC: なし

### `path/to/file2.ts`

関連SPEC:
- [SPEC-STP-001](docs/specs/SPEC-STP-001.md): 顧問の区分表示形式

禁止事項:
- ❌ 未入力時に括弧を省略する
```

#### 4. 関連SPECと禁止事項の整理

```markdown
## 関連SPECサマリー

| SPEC ID | 概要 | 禁止事項 |
|---------|------|---------|
| SPEC-STP-001 | 顧問の表示形式 | 括弧省略禁止、スラッシュ区切り固定 |

## この実装で注意すべき点

- [注意点1]
- [注意点2]
```

#### 5. 実装計画の提示

```markdown
## 実装計画

### Step 1: [タスク名]

変更ファイル: `path/to/file.tsx`
変更内容:
- [変更1]
- [変更2]

### Step 2: [タスク名]

...
```

#### 6. E2E実行判定

実装後にPlaywrightで実機確認が必要かを判定する。

```markdown
## E2E実行判定

**Playwright実行:** 必要 / 不要

**判定理由:** [理由を記載]

**実行する場合の確認観点:**
1. [観点1：対象画面・確認内容]
2. [観点2：対象画面・確認内容]
...（2〜5項目）
```

**Playwrightが必要な条件:**
- UI/UX変更（表示崩れ、モーダル、スクロール、インライン編集、画面遷移）
- フォーム入力・バリデーション・送信導線の変更
- 複数コンポーネント連携の変更
- ユーザーが「画面で確認して」と明示した場合
- 過去に不具合が多い領域（`docs/troubleshooting.md` 記載の既知問題箇所）

**Playwrightが不要な条件:**
- 文言変更のみ
- サーバー側ロジックのみでUI無変更
- 型修正・リファクタで挙動不変
- 既存テストで十分に担保できる変更

#### 7. 承認待ち

```markdown
---

⏳ **承認待ち**

上記の計画で実装を進めてよろしいですか？
- 「はい」または「OK」で実装開始
- 修正点があればお知らせください
```

#### 8. ユーザー承認後に実装

**承認前に実装しないこと。**

#### 9. テスト実行

実装完了後、以下を実行：

```bash
docker-compose exec app npm run test:specs
```

#### 10. Playwright実行（判定が「必要」の場合のみ）

E2E実行判定で「必要」と判定した場合のみ実行する。

**実行ルール:**
- 必要最小限のシナリオのみ実行（過剰に回さない）
- 対象画面へのナビゲーション → 確認観点の検証 の順で進める
- スナップショットでUI確認、必要ならスクリーンショット取得

**結果出力形式:**

```markdown
## Playwright実行結果

| シナリオ | 結果 | 備考 |
|---------|------|------|
| [シナリオ1] | ✅ pass / ❌ fail | [備考] |
| [シナリオ2] | ✅ pass / ❌ fail | [備考] |

**失敗時の対応:**
- 再現手順: [手順]
- スクリーンショット: [パス]（必要時のみ）
```

#### 11. 最終報告

```markdown
## 最終報告

### 実装内容
- [変更点1]
- [変更点2]

### テスト結果
- `test:specs`: ✅ pass / ❌ fail

### Playwright
- **実行:** 実行 / 未実行
- **結果:** ✅ 全シナリオpass / ❌ 失敗あり（上記参照）
- **未実行の場合の理由:** [省略理由]
```

#### 12. /record --dry-run の提案

```markdown
## 記録の提案

今回の実装で記録すべき内容があるか確認します。

`/record --dry-run` を実行しますか？
```

## 必須出力順序

deepモードでは必ず以下の順序で出力すること：

1. 調査結果（要望分解 → 影響ファイル → 仕様チェック）
2. 関連SPEC（サマリー）
3. 実装計画
4. E2E実行判定
5. 承認待ち
6. （承認後）実装 → テスト → Playwright（必要時）→ 最終報告

## 禁止事項

- ❌ 承認前に実装を開始する
- ❌ 無関係なファイルを変更する
- ❌ 調査フェーズをスキップする
- ❌ 確定仕様チェックを省略する
- ❌ E2E実行判定を省略する
- ❌ Playwright「必要」判定時に実行せずに完了報告する

## 引数

| 引数 | 説明 | 例 |
|------|------|-----|
| なし | 厳密モード開始、要望入力を待つ | `/deep` |
| 要望テキスト | 厳密モードで即座に調査開始 | `/deep ステージ表示を変更したい` |

## 使用例

```
/deep
> （ユーザー）顧問の件数表示を修正したい
（調査結果 → 関連SPEC → 実装計画 → 承認待ち）
> （ユーザー）OK
（実装開始）
```

## 通常モードへの切り替え

`/quick` で通常実装モードに戻れます。

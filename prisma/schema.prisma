generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 全顧客マスタ (Stella Companies)
// ============================================

model MasterStellaCompany {
  id            Int      @id @default(autoincrement())
  companyCode   String   @unique @db.VarChar(20)  // SC-1, SC-2...
  name          String   @db.VarChar(200)         // 企業名
  websiteUrl    String?  @db.VarChar(500)         // 企業HP
  industry      String?  @db.VarChar(100)         // 業界（自由入力）
  revenueScale  String?  @db.VarChar(100)         // 売上規模（自由入力）
  staffId       Int?                              // 担当者（AS）
  note          String?                           // メモ
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff                MasterStaff?         @relation(fields: [staffId], references: [id])
  locations            StellaCompanyLocation[]
  contacts             StellaCompanyContact[]
  stpCompanies         StpCompany[]
  stpContractHistories StpContractHistory[]
  agentCompanies       StpAgent[]           @relation("AgentCompany")
  referredAgents       StpAgent[]           @relation("ReferrerCompany")
  contracts            MasterContract[]
  contactHistories     ContactHistory[]
  externalUsers        ExternalUser[]
  registrationTokens   RegistrationToken[]

  @@map("master_stella_companies")
}

// ============================================
// 企業拠点 (Stella Company Locations)
// 本社・支社などの拠点情報
// ============================================

model StellaCompanyLocation {
  id         Int       @id @default(autoincrement())
  companyId  Int                                    // MasterStellaCompanyへの外部キー
  name       String    @db.VarChar(100)             // 拠点名（本社、大阪支店など）
  address    String?                                // 住所
  phone      String?   @db.VarChar(50)              // 電話番号
  email      String?   @db.VarChar(255)             // メールアドレス
  isPrimary  Boolean   @default(false)              // 主要拠点フラグ
  note       String?                                // 備考
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?                              // 論理削除日時

  // Relations
  company MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("stella_company_locations")
}

// ============================================
// 企業担当者 (Stella Company Contacts)
// ============================================

model StellaCompanyContact {
  id         Int       @id @default(autoincrement())
  companyId  Int                                    // MasterStellaCompanyへの外部キー
  name       String    @db.VarChar(100)             // 担当者名
  email      String?   @db.VarChar(255)             // メールアドレス
  phone      String?   @db.VarChar(50)              // 電話番号
  department String?   @db.VarChar(100)             // 担当部署
  isPrimary  Boolean   @default(false)              // 主連絡先フラグ
  note       String?                                // 備考
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?                              // 論理削除日時

  // Relations
  company      MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  externalUser ExternalUser?

  @@map("stella_company_contacts")
}

// ============================================
// 代理店マスタ (STP Agents)
// ============================================

model StpAgent {
  id                Int       @id @default(autoincrement())
  companyId         Int       @unique                          // 代理店企業（MasterStellaCompanyへの外部キー）
  status            String    @db.VarChar(20)                   // アクティブ/非アクティブ/解約
  category1         String    @db.VarChar(20)                   // 代理店/顧問
  contractStatus    String?   @db.VarChar(20)                   // 契約済み/商談済み/未商談/日程調整中
  referrerCompanyId Int?                                        // 紹介者（MasterStellaCompanyへの外部キー）
  note              String?                                     // 代理店メモ
  minimumCases      Int?                                        // 最低件数（顧問のみ）
  monthlyFee        Int?                                        // 月額費用（顧問のみ）
  hearingUrl        String?   @db.VarChar(500)                  // ヒアリングURL
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  company          MasterStellaCompany  @relation("AgentCompany", fields: [companyId], references: [id])
  referrerCompany  MasterStellaCompany? @relation("ReferrerCompany", fields: [referrerCompanyId], references: [id])
  stpCompanies     StpCompany[]
  contracts        StpAgentContract[]
  staffAssignments StpAgentStaff[]
  leadFormToken    StpLeadFormToken?

  @@map("stp_agents")
}

// ============================================
// 代理店契約書 (STP Agent Contracts)
// 将来のクラウドサインAPI連携対応
// ============================================

model StpAgentContract {
  id              Int       @id @default(autoincrement())
  agentId         Int
  contractUrl     String                                     // 契約書URL
  signedDate      DateTime? @db.Date                         // 締結日（未締結はnull）
  title           String?   @db.VarChar(200)                 // 契約書タイトル
  externalId      String?   @db.VarChar(100)                 // 外部サービスID（クラウドサイン等）
  externalService String?   @db.VarChar(50)                  // 外部サービス名
  status          String    @default("signed") @db.VarChar(20) // draft/pending/signed/expired
  note            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agent StpAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("stp_agent_contracts")
}

// ============================================
// 代理店担当者 (STP Agent Staff)
// 担当者の複数選択用中間テーブル
// ============================================

model StpAgentStaff {
  id        Int      @id @default(autoincrement())
  agentId   Int
  staffId   Int
  createdAt DateTime @default(now())

  agent StpAgent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  staff MasterStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([agentId, staffId])
  @@map("stp_agent_staff")
}

// ============================================
// 商談ステージマスタ (STP)
// ============================================

model StpStage {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(50)
  displayOrder Int?                                   // NULLable（特殊ステージ用）
  stageType    String   @default("progress") @db.VarChar(20)  // 'progress', 'closed_won', 'closed_lost', 'pending'
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  currentStageCompanies StpCompany[]       @relation("CurrentStage")
  targetStageCompanies  StpCompany[]       @relation("TargetStage")
  fromStageHistories    StpStageHistory[]  @relation("FromStage")
  toStageHistories      StpStageHistory[]  @relation("ToStage")

  @@map("stp_stages")
}

// ============================================
// 接触方法マスタ (Contact Methods) - 全プロジェクト共通
// ============================================

model ContactMethod {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(50)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  contactHistories ContactHistory[]

  @@map("contact_methods")
}

// ============================================
// 流入経路マスタ (STP Lead Sources)
// ============================================

model StpLeadSource {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(100)
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stpCompanies StpCompany[]

  @@map("stp_lead_sources")
}

// ============================================
// 連絡方法マスタ (STP Communication Methods) - 企業との連絡方法
// ============================================

model StpCommunicationMethod {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(100)
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stpCompanies StpCompany[]

  @@map("stp_communication_methods")
}

// ============================================
// 採用ブーストプロジェクト企業 (STP Companies)
// ============================================

model StpCompany {
  id                Int       @id @default(autoincrement())
  companyId         Int                                    // master_stella_companiesへの外部キー
  agentId           Int?                                   // 代理店ID（stp_agentsへの外部キー）

  // ステージ管理
  currentStageId    Int?                                   // 現在のステージ
  nextTargetStageId Int?                                   // ネクストステージコミット
  nextTargetDate    DateTime? @db.Date                     // 次の商談日コミット

  // 日付情報
  leadAcquiredDate     DateTime? @db.Date                  // リード獲得日
  meetingDate          DateTime? @db.Date                  // 初回商談日
  firstKoDate          DateTime? @db.Date                  // 初回KO日
  jobPostingStartDate  String?   @db.VarChar(100)          // 求人掲載開始日（テキスト入力）

  // 進捗・ステータス
  progressDetail    String?                                // 進捗詳細
  forecast          String?   @db.VarChar(20)              // ヨミ（MIN,落とし,MAX,来月,辞退）
  operationStatus   String?   @db.VarChar(20)              // 運用ステータス（テスト1,テスト2）
  lostReason        String?                                // 失注理由

  // 企業情報
  industryType      String?   @db.VarChar(20)              // 業種区分（一般,派遣）
  industry          String?   @db.VarChar(100)             // 業界
  plannedHires      Int?                                   // 採用予定人数
  leadSourceId      Int?                                   // 流入経路（マスタから選択）

  // 契約情報
  contractPlan      String?   @db.VarChar(50)              // 契約プラン（後でロジック構築・自動入力）
  media             String?   @db.VarChar(100)             // 媒体（テキスト入力）
  contractStartDate DateTime? @db.Date                     // 契約開始日（後でロジック構築・自動入力）
  contractEndDate   DateTime? @db.Date                     // 契約終了日（後でロジック構築・自動入力）
  initialFee        Int?                                   // 初期費用（0, 100000, 150000）
  monthlyFee        Int?                                   // 月額
  performanceFee    Int?                                   // 成果報酬単価
  salesStaffId      Int?                                   // 担当営業（Staffから選択）
  operationStaffList String?  @db.VarChar(100)             // 担当運用（複数選択：indeed,運用2等）

  // アカウント情報
  accountId         String?   @db.VarChar(100)             // アカウントID
  accountPass       String?   @db.VarChar(100)             // アカウントPASS

  // リンク情報
  jobInfoFolderLink    String?                             // 求人票/会社情報フォルダリンク
  operationReportLink  String?                             // 運用進捗レポートリンク
  proposalLink         String?                             // 提案書リンク

  // 請求先情報（全顧客マスタの拠点・担当者から選択）
  billingLocationId      Int?                              // 請求先住所（拠点ID）
  billingCompanyName     String?  @db.VarChar(200)         // 請求先企業名
  billingAddress         String?                           // 請求先住所（選択時にコピー）
  billingRepresentative  String?  @db.VarChar(100)         // 請求先担当者ID（カンマ区切りで複数保存）
  paymentTerms           String?  @db.VarChar(100)         // 支払いサイト

  // 連絡方法
  communicationMethodId Int?                               // 連絡方法（マスタから選択）

  // その他
  note              String?                                // 企業メモ
  contractNote      String?                                // 契約メモ

  // 検討中専用
  pendingReason       String?                              // 検討中理由
  pendingResponseDate DateTime? @db.Date                   // 回答予定日

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  company             MasterStellaCompany     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  currentStage        StpStage?               @relation("CurrentStage", fields: [currentStageId], references: [id])
  nextTargetStage     StpStage?               @relation("TargetStage", fields: [nextTargetStageId], references: [id])
  agent               StpAgent?               @relation(fields: [agentId], references: [id])
  leadSource          StpLeadSource?          @relation(fields: [leadSourceId], references: [id])
  communicationMethod StpCommunicationMethod? @relation(fields: [communicationMethodId], references: [id])
  salesStaff          MasterStaff?            @relation("SalesStaffCompanies", fields: [salesStaffId], references: [id])
  stageHistories      StpStageHistory[]
  contracts           StpCompanyContract[]
  proposals           StpProposal[]
  kpiSheets           StpKpiSheet[]

  @@map("stp_companies")
}

// ============================================
// STP企業契約書 (STP Company Contracts)
// ============================================

model StpCompanyContract {
  id              Int       @id @default(autoincrement())
  stpCompanyId    Int                                     // stp_companiesへの外部キー
  contractUrl     String?                                 // 契約書URL
  signedDate      DateTime? @db.Date                      // 締結日（未締結はnull）
  title           String?   @db.VarChar(200)              // 契約書タイトル
  externalId      String?   @db.VarChar(100)              // 外部サービスID（クラウドサイン等）
  externalService String?   @db.VarChar(50)               // 外部サービス名
  status          String    @default("draft") @db.VarChar(50) // draft/送付済み/先方情報待ち/signed/expired等
  note            String?                                 // 備考
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  stpCompany StpCompany @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)

  @@map("stp_company_contracts")
}

// ============================================
// 接触履歴 (Contact Histories)
// 全プロジェクト共通の接触履歴を管理
// ============================================

model ContactHistory {
  id                   Int       @id @default(autoincrement())
  companyId            Int       @map("company_id")
  contactDate          DateTime  @map("contact_date")
  contactMethodId      Int?      @map("contact_method_id")
  staffId              Int?      @map("staff_id")
  assignedTo           String?   @db.VarChar(255) @map("assigned_to") // 後方互換のため残存
  customerParticipants String?   @db.VarChar(500) @map("customer_participants")
  meetingMinutes       String?   @map("meeting_minutes")
  note                 String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  // Relations
  company       MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactMethod ContactMethod?      @relation(fields: [contactMethodId], references: [id])
  staff         MasterStaff?        @relation(fields: [staffId], references: [id])
  roles         ContactHistoryRole[]
  files         ContactHistoryFile[]

  @@index([companyId], map: "idx_contact_histories_company_id")
  @@index([contactDate], map: "idx_contact_histories_contact_date")
  @@index([deletedAt], map: "idx_contact_histories_deleted_at")
  @@index([staffId], map: "idx_contact_histories_staff_id")
  @@map("contact_histories")
}

// ============================================
// 接触履歴ファイル (Contact History Files)
// 接触履歴に添付されたファイルを管理
// ============================================

model ContactHistoryFile {
  id               Int       @id @default(autoincrement())
  contactHistoryId Int       @map("contact_history_id")
  filePath         String    @db.VarChar(500) @map("file_path")
  fileName         String    @db.VarChar(200) @map("file_name")
  fileSize         Int       @map("file_size")
  mimeType         String    @db.VarChar(100) @map("mime_type")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  contactHistory ContactHistory @relation(fields: [contactHistoryId], references: [id], onDelete: Cascade)

  @@index([contactHistoryId], map: "idx_contact_history_files_contact_history_id")
  @@map("contact_history_files")
}

// ============================================
// 接触履歴ロール (Contact History Roles)
// 接触履歴と顧客種別の中間テーブル
// ============================================

model ContactHistoryRole {
  id               Int      @id @default(autoincrement())
  contactHistoryId Int      @map("contact_history_id")
  customerTypeId   Int      @map("customer_type_id")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  contactHistory ContactHistory @relation(fields: [contactHistoryId], references: [id], onDelete: Cascade)
  customerType   CustomerType   @relation(fields: [customerTypeId], references: [id])

  @@unique([contactHistoryId, customerTypeId])
  @@index([contactHistoryId], map: "idx_contact_history_roles_contact_history_id")
  @@index([customerTypeId], map: "idx_contact_history_roles_customer_type_id")
  @@map("contact_history_roles")
}

// ============================================
// 顧客種別マスタ (Customer Types)
// プロジェクトごとの顧客種別を管理
// ============================================

model CustomerType {
  id           Int      @id @default(autoincrement())
  projectId    Int      @map("project_id")
  name         String   @db.VarChar(50)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  project MasterProject        @relation(fields: [projectId], references: [id])
  roles   ContactHistoryRole[]

  @@unique([projectId, name])
  @@index([projectId], map: "idx_customer_types_project_id")
  @@map("customer_types")
}

// ============================================
// ステージ変更履歴 (STP Stage Histories)
// ============================================

model StpStageHistory {
  id                Int       @id @default(autoincrement())
  stpCompanyId      Int                                        // stp_companiesへの外部キー
  eventType         String    @db.VarChar(20)                  // commit, achieved, recommit, progress, back, cancel, won, lost, suspended, resumed, revived, reason_updated
  fromStageId       Int?                                       // 変更前ステージ
  toStageId         Int?                                       // 変更後ステージ
  targetDate        DateTime? @db.Date                         // 目標日
  recordedAt        DateTime  @default(now())                  // 記録日時
  changedBy         String?   @db.VarChar(100)                 // 変更者
  note              String?                                    // 備考
  isCorrected       Boolean   @default(false)                  // この履歴は修正されたか
  alertAcknowledged Boolean   @default(false)                  // アラートを確認して更新したか

  // 失注・検討中理由
  lostReason    String?                                        // 失注理由
  pendingReason String?                                        // 検討中理由

  // サブタイプ（recommit用: positive, negative, neutral）
  subType       String?   @db.VarChar(20)

  // 論理削除
  isVoided      Boolean   @default(false)                      // 取り消しフラグ
  voidedAt      DateTime?                                      // 取り消し日時
  voidedBy      String?   @db.VarChar(100)                     // 取り消した人
  voidReason    String?                                        // 取り消し理由

  // Relations
  stpCompany StpCompany @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  fromStage  StpStage?  @relation("FromStage", fields: [fromStageId], references: [id])
  toStage    StpStage?  @relation("ToStage", fields: [toStageId], references: [id])

  @@map("stp_stage_histories")
}

// ============================================
// スタッフマスタ (Master Staff)
// 社内スタッフ・担当者管理
// ============================================

model MasterStaff {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(100)                 // 名前
  nameKana     String?   @db.VarChar(100)                 // フリガナ
  email        String?   @unique @db.VarChar(255)         // メールアドレス
  phone        String?   @db.VarChar(20)                  // 電話番号
  contractType String?   @db.VarChar(50)                  // 契約形態（正社員、契約社員、業務委託など）
  loginId      String?   @unique @db.VarChar(100)         // ログインID
  passwordHash         String?   @db.VarChar(255)                 // パスワード（ハッシュ化）
  inviteToken          String?   @unique @db.VarChar(64)          // 招待トークン
  inviteTokenExpiresAt DateTime?                                  // 招待トークン有効期限
  isActive             Boolean   @default(true)                   // 有効フラグ
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  permissions                 StaffPermission[]
  roleAssignments             StaffRoleAssignment[]
  projectAssignments          StaffProjectAssignment[]
  salesContractHistories      StpContractHistory[]   @relation("SalesStaff")
  operationContractHistories  StpContractHistory[]   @relation("OperationStaff")
  agentAssignments            StpAgentStaff[]
  assignedCompanies           MasterStellaCompany[]
  salesStpCompanies           StpCompany[]           @relation("SalesStaffCompanies")
  contactHistories            ContactHistory[]
  approvedExternalUsers       ExternalUser[]
  issuedRegistrationTokens    RegistrationToken[]
  processedLeadSubmissions    StpLeadFormSubmission[]

  @@map("master_staff")
}

// ============================================
// スタッフ役割種別マスタ (Staff Role Types)
// スタッフが担当できる役割の種別
// ============================================

model StaffRoleType {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)          // 営業, 運用, CS, AS など
  name         String   @db.VarChar(100)                 // 表示名
  description  String?                                   // 説明
  displayOrder Int      @default(0)                      // 表示順
  isActive     Boolean  @default(true)                   // 有効フラグ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  staffAssignments StaffRoleAssignment[]

  @@map("staff_role_types")
}

// ============================================
// スタッフ役割割当 (Staff Role Assignments) - 廃止予定
// 後方互換のため残存、新規はStaffProjectRoleAssignmentを使用
// ============================================

model StaffRoleAssignment {
  id         Int      @id @default(autoincrement())
  staffId    Int
  roleTypeId Int
  createdAt  DateTime @default(now())

  staff    MasterStaff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  roleType StaffRoleType @relation(fields: [roleTypeId], references: [id], onDelete: Cascade)

  @@unique([staffId, roleTypeId])
  @@map("staff_role_assignments")
}

// ============================================
// スタッフプロジェクト割当 (Staff Project Assignments)
// スタッフ×プロジェクトの多対多中間テーブル
// 担当者選択時にプロジェクトで絞り込み可能
// ============================================

model StaffProjectAssignment {
  id        Int      @id @default(autoincrement())
  staffId   Int
  projectId Int
  createdAt DateTime @default(now())

  staff   MasterStaff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  project MasterProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([staffId, projectId])
  @@map("staff_project_assignments")
}

// ============================================
// スタッフ権限 (Staff Permissions)
// プロジェクトごとの閲覧・変更権限を管理
// ============================================

model StaffPermission {
  id              Int      @id @default(autoincrement())
  staffId         Int                                     // master_staffへの外部キー
  projectCode     String   @db.VarChar(50)                // プロジェクトコード（例: stp, stella）
  permissionLevel String   @db.VarChar(20)                // none, view, edit, admin
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  staff MasterStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, projectCode])
  @@map("staff_permissions")
}

// ============================================
// 契約履歴 (STP Contract Histories)
// ============================================

model StpContractHistory {
  id                Int       @id @default(autoincrement())
  companyId         Int                                    // master_stella_companiesへの外部キー
  industryType      String    @db.VarChar(20)              // general（一般）, dispatch（派遣）
  contractPlan      String    @db.VarChar(20)              // monthly（月額）, performance（成果報酬）
  jobMedia          String?   @db.VarChar(50)              // 求人媒体（Indeed, Wantedly等）
  contractStartDate DateTime  @db.Date                     // 契約開始日
  contractEndDate   DateTime? @db.Date                     // 契約終了日（nullの場合アクティブ）
  initialFee        Int                                    // 初期費用（0, 100000, 150000）
  monthlyFee        Int                                    // 月額（契約時点の金額を保存）
  performanceFee    Int                                    // 成果報酬単価（契約時点の金額を保存）
  salesStaffId      Int?                                   // 担当営業（master_staffへの外部キー）
  operationStaffId  Int?                                   // 担当運用（master_staffへの外部キー）
  status            String    @db.VarChar(20)              // active, cancelled, dormant
  note              String?                                // 備考
  operationStatus   String?   @db.VarChar(20)              // 運用ステータス（テスト1,テスト2）
  accountId         String?   @db.VarChar(100)             // アカウントID
  accountPass       String?   @db.VarChar(100)             // アカウントPASS
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?                              // 論理削除日時

  // Relations
  company        MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesStaff     MasterStaff?        @relation("SalesStaff", fields: [salesStaffId], references: [id])
  operationStaff MasterStaff?        @relation("OperationStaff", fields: [operationStaffId], references: [id])

  @@map("stp_contract_histories")
}

// ============================================
// プロジェクトマスタ (Master Projects)
// ============================================

model MasterProject {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(100)
  description  String?
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  contracts          MasterContract[]
  staffAssignments   StaffProjectAssignment[]
  customerTypes      CustomerType[]

  @@map("master_projects")
}

// ============================================
// 契約書ステータスマスタ (Master Contract Statuses)
// ============================================

model MasterContractStatus {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(50)
  displayOrder Int       @default(0) @map("display_order")
  isTerminal   Boolean   @default(false) @map("is_terminal")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  contractsCurrent       MasterContract[]                  @relation("CurrentStatus")
  historiesFrom          MasterContractStatusHistory[]     @relation("FromStatus")
  historiesTo            MasterContractStatusHistory[]     @relation("ToStatus")

  @@map("master_contract_statuses")
}

// ============================================
// 契約書テーブル (Master Contracts)
// ============================================

model MasterContract {
  id                    Int       @id @default(autoincrement())
  companyId             Int       @map("company_id")
  projectId             Int       @map("project_id")
  contractNumber        String?   @db.VarChar(50) @map("contract_number")
  parentContractId      Int?      @map("parent_contract_id")
  contractType          String    @db.VarChar(50) @map("contract_type")
  title                 String    @db.VarChar(200)
  startDate             DateTime? @db.Date @map("start_date")
  endDate               DateTime? @db.Date @map("end_date")
  currentStatusId       Int?      @map("current_status_id")
  targetDate            DateTime? @db.Date @map("target_date")
  signedDate            DateTime? @db.Date @map("signed_date")
  isActive              Boolean   @default(false) @map("is_active")
  signingMethod         String?   @db.VarChar(20) @map("signing_method")
  cloudsignDocumentId   String?   @db.VarChar(100) @map("cloudsign_document_id")
  cloudsignStatus       String?   @db.VarChar(30) @map("cloudsign_status")
  cloudsignSentAt       DateTime? @map("cloudsign_sent_at")
  cloudsignCompletedAt  DateTime? @map("cloudsign_completed_at")
  cloudsignUrl          String?   @db.VarChar(500) @map("cloudsign_url")
  filePath              String?   @db.VarChar(500) @map("file_path")
  fileName              String?   @db.VarChar(200) @map("file_name")
  assignedTo            String?   @db.VarChar(100) @map("assigned_to")
  note                  String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  company               MasterStellaCompany       @relation(fields: [companyId], references: [id])
  project               MasterProject             @relation(fields: [projectId], references: [id])
  currentStatus         MasterContractStatus?     @relation("CurrentStatus", fields: [currentStatusId], references: [id])
  parentContract        MasterContract?           @relation("ContractHierarchy", fields: [parentContractId], references: [id])
  childContracts        MasterContract[]          @relation("ContractHierarchy")
  statusHistories       MasterContractStatusHistory[]

  @@index([companyId], map: "idx_master_contracts_company_id")
  @@index([projectId], map: "idx_master_contracts_project_id")
  @@index([companyId, projectId], map: "idx_master_contracts_company_project")
  @@index([currentStatusId], map: "idx_master_contracts_current_status_id")
  @@index([isActive], map: "idx_master_contracts_is_active")
  @@index([cloudsignDocumentId], map: "idx_master_contracts_cloudsign_document_id")
  @@map("master_contracts")
}

// ============================================
// 契約書ステータス変更履歴 (Master Contract Status Histories)
// ============================================

model MasterContractStatusHistory {
  id           Int       @id @default(autoincrement())
  contractId   Int       @map("contract_id")
  eventType    String    @db.VarChar(30) @map("event_type")
  fromStatusId Int?      @map("from_status_id")
  toStatusId   Int?      @map("to_status_id")
  targetDate   DateTime? @db.Date @map("target_date")
  changedBy    String?   @db.VarChar(100) @map("changed_by")
  note         String?
  recordedAt   DateTime  @default(now()) @map("recorded_at")

  contract     MasterContract             @relation(fields: [contractId], references: [id])
  fromStatus   MasterContractStatus?      @relation("FromStatus", fields: [fromStatusId], references: [id])
  toStatus     MasterContractStatus?      @relation("ToStatus", fields: [toStatusId], references: [id])

  @@index([contractId], map: "idx_master_contract_status_histories_contract_id")
  @@index([recordedAt], map: "idx_master_contract_status_histories_recorded_at")
  @@map("master_contract_status_histories")
}

// ============================================
// 外部ユーザー (External Users)
// クライアント・代理店担当者向けログインアカウント
// ============================================

model ExternalUser {
  id                  Int       @id @default(autoincrement())
  companyId           Int                                      // 所属企業（MasterStellaCompanyへの外部キー）
  registrationTokenId Int?                                     // 登録に使用されたトークン
  contactId           Int?      @unique                        // 担当者情報（任意、StellaCompanyContactへの外部キー）
  name                String    @db.VarChar(100)               // 名前
  position            String?   @db.VarChar(100)               // 役職
  email               String    @unique @db.VarChar(255)       // ログイン用メールアドレス
  passwordHash        String    @db.VarChar(255)               // パスワード（ハッシュ化）
  status              String    @default("pending_email") @db.VarChar(20)  // pending_email/pending_approval/active/suspended
  emailVerifiedAt     DateTime?                                // メール認証日時
  approvedAt          DateTime?                                // 管理者承認日時
  approvedBy          Int?                                     // 承認者（MasterStaffへの外部キー）
  lastLoginAt         DateTime?                                // 最終ログイン日時
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  company                   MasterStellaCompany              @relation(fields: [companyId], references: [id])
  registrationToken         RegistrationToken?               @relation(fields: [registrationTokenId], references: [id])
  contact                   StellaCompanyContact?            @relation(fields: [contactId], references: [id])
  approver                  MasterStaff?                     @relation(fields: [approvedBy], references: [id])
  displayPermissions        ExternalUserDisplayPermission[]
  loginHistories            LoginHistory[]
  emailVerificationTokens   EmailVerificationToken[]
  passwordResetTokens       PasswordResetToken[]

  @@index([companyId])
  @@index([status])
  @@map("external_users")
}

// ============================================
// 表示ビュー定義 (Display Views)
// 外部ユーザー向け画面の定義
// ============================================

model DisplayView {
  id           Int      @id @default(autoincrement())
  viewKey      String   @unique @db.VarChar(50)     // stp_client, stp_agent
  viewName     String   @db.VarChar(100)            // 採用ブースト（クライアント版）
  projectCode  String   @db.VarChar(50)             // stp, stella
  description  String?                              // 説明
  isActive     Boolean  @default(true)              // 有効フラグ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  userPermissions            ExternalUserDisplayPermission[]
  registrationTokenDefaults  RegistrationTokenDefaultView[]

  @@map("display_views")
}

// ============================================
// 外部ユーザー表示権限 (External User Display Permissions)
// ユーザー×ビューの権限管理
// ============================================

model ExternalUserDisplayPermission {
  id             Int      @id @default(autoincrement())
  externalUserId Int
  displayViewId  Int
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)
  displayView  DisplayView  @relation(fields: [displayViewId], references: [id])

  @@unique([externalUserId, displayViewId])
  @@map("external_user_display_permissions")
}

// ============================================
// 登録トークン (Registration Tokens)
// 外部ユーザー登録用の招待トークン
// ============================================

model RegistrationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique @db.VarChar(64)       // 招待トークン
  companyId Int                                     // 対象企業（MasterStellaCompanyへの外部キー）
  name      String?  @db.VarChar(100)              // 管理名（誰向けか等）
  note      String?                                 // 備考
  expiresAt DateTime                                // 有効期限
  maxUses   Int      @default(1)                    // 最大使用回数
  useCount  Int      @default(0)                    // 使用回数
  status    String   @default("active") @db.VarChar(20)  // active/expired/exhausted/revoked
  issuedBy  Int                                     // 発行者（MasterStaffへの外部キー）
  createdAt DateTime @default(now())

  // Relations
  company       MasterStellaCompany            @relation(fields: [companyId], references: [id])
  issuer        MasterStaff                    @relation(fields: [issuedBy], references: [id])
  defaultViews  RegistrationTokenDefaultView[]
  externalUsers ExternalUser[]

  @@index([token])
  @@map("registration_tokens")
}

// ============================================
// 登録トークンデフォルトビュー (Registration Token Default Views)
// トークン発行時に指定するデフォルトの表示権限
// ============================================

model RegistrationTokenDefaultView {
  id                  Int      @id @default(autoincrement())
  registrationTokenId Int
  displayViewId       Int
  createdAt           DateTime @default(now())

  // Relations
  registrationToken RegistrationToken @relation(fields: [registrationTokenId], references: [id], onDelete: Cascade)
  displayView       DisplayView       @relation(fields: [displayViewId], references: [id])

  @@unique([registrationTokenId, displayViewId])
  @@map("registration_token_default_views")
}

// ============================================
// メール認証トークン (Email Verification Tokens)
// メールアドレス確認用トークン
// ============================================

model EmailVerificationToken {
  id             Int      @id @default(autoincrement())
  token          String   @unique @db.VarChar(64)  // 認証トークン
  externalUserId Int                                // 外部ユーザー（ExternalUserへの外部キー）
  expiresAt      DateTime                           // 有効期限
  isUsed         Boolean  @default(false)           // 使用済みフラグ
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

// ============================================
// パスワードリセットトークン (Password Reset Tokens)
// パスワード再設定用トークン
// ============================================

model PasswordResetToken {
  id             Int      @id @default(autoincrement())
  token          String   @unique @db.VarChar(64)  // リセットトークン
  externalUserId Int                                // 外部ユーザー（ExternalUserへの外部キー）
  expiresAt      DateTime                           // 有効期限
  isUsed         Boolean  @default(false)           // 使用済みフラグ
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_reset_tokens")
}

// ============================================
// ログイン履歴 (Login Histories)
// 外部ユーザーのログイン記録
// ============================================

model LoginHistory {
  id             Int      @id @default(autoincrement())
  externalUserId Int                                // 外部ユーザー（ExternalUserへの外部キー）
  loginAt        DateTime @default(now())           // ログイン日時
  ipAddress      String?  @db.VarChar(45)           // IPアドレス
  userAgent      String?                            // ユーザーエージェント
  result         String   @db.VarChar(20)           // success/failure
  failureReason  String?  @db.VarChar(50)           // 失敗理由

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)

  @@index([externalUserId])
  @@index([loginAt])
  @@map("login_histories")
}

// ============================================
// STPリード獲得フォームトークン (STP Lead Form Tokens)
// 代理店ごとのユニークフォームURL管理
// ============================================

model StpLeadFormToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique @db.VarChar(64)       // URLトークン
  agentId   Int       @unique                       // 代理店ID（1代理店につき1トークン）
  status    String    @default("active") @db.VarChar(20)  // active/paused/revoked
  expiresAt DateTime?                               // 有効期限（nullは無期限）
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  agent       StpAgent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
  submissions StpLeadFormSubmission[]

  @@index([token])
  @@map("stp_lead_form_tokens")
}

// ============================================
// STPリード獲得フォーム回答 (STP Lead Form Submissions)
// フォーム回答データ
// ============================================

model StpLeadFormSubmission {
  id              Int       @id @default(autoincrement())
  tokenId         Int                                     // フォームトークンへのFK
  stpCompanyId    Int?                                    // 作成されたSTP企業ID
  masterCompanyId Int?                                    // 紐付けられた全顧客マスタID

  // 回答者情報
  companyName     String    @db.VarChar(200)              // 会社名
  contactName     String    @db.VarChar(100)              // 担当者氏名
  contactEmail    String    @db.VarChar(255)              // メールアドレス
  contactPhone    String?   @db.VarChar(50)               // 電話番号

  // 採用実績情報
  pastHiringJobTypes       String?                        // 過去採用経験のある職種（JSON）
  pastRecruitingCostAgency Int?                           // 人材紹介費用（円）
  pastRecruitingCostAds    Int?                           // 求人広告費用（円）
  pastRecruitingCostReferral Int?                         // リファラル費用（円）
  pastRecruitingCostOther  Int?                           // その他費用（円）
  pastHiringCount          Int?                           // 過去採用人数

  // 希望情報
  desiredJobTypes          String?                        // 希望職種（JSON）
  annualBudget             Int?                           // 年間採用予算（円）
  annualHiringTarget       Int?                           // 年間希望採用人数
  hiringAreas              String?                        // 採用エリア（JSON: 都道府県）
  hiringTimeline           String?   @db.VarChar(100)     // 採用希望時期（月）
  ageRangeMin              Int?                           // 採用可能年齢: 下限（旧フォーム互換用）
  ageRangeMax              Int?                           // 採用可能年齢: 上限（旧フォーム互換用）
  ageRange                 String?   @db.VarChar(10)      // 採用可能年齢幅（不問, 〜30, 〜35, etc.）
  requiredConditions       String?                        // 必須条件
  preferredConditions      String?                        // 希望条件

  // メタ情報
  status          String    @default("pending") @db.VarChar(20)  // pending/processed/rejected
  processedAt     DateTime?                               // 処理日時
  processedBy     Int?                                    // 処理者（MasterStaffへのFK）
  processingNote  String?                                 // 処理メモ
  submittedAt     DateTime  @default(now())               // 回答日時
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  token         StpLeadFormToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  processor     MasterStaff?     @relation(fields: [processedBy], references: [id])
  proposals     StpProposal[]

  @@index([tokenId])
  @@index([status])
  @@index([submittedAt])
  @@map("stp_lead_form_submissions")
}

// ============================================
// STP提案書 (STP Proposals)
// ヒアリングフォームからの自動生成および手動作成
// ============================================

model StpProposal {
  id              Int       @id @default(autoincrement())

  // 紐付け（両方nullable、アプリ層でバリデーション）
  stpCompanyId    Int?                                    // STP企業への外部キー
  submissionId    Int?                                    // フォーム回答への外部キー

  // 基本情報
  title           String    @db.VarChar(200)              // 提案書タイトル
  proposalNumber  String?   @db.VarChar(50)               // 提案書番号（自動採番）

  // ファイル情報（PDFアップロード時）
  filePath        String?   @db.VarChar(500)
  fileName        String?   @db.VarChar(200)

  // 外部URL（Canva, Google Docs等）
  externalUrl     String?   @db.VarChar(500)
  externalService String?   @db.VarChar(50)               // canva/google_docs/other

  // ステータス
  status          String    @default("draft") @db.VarChar(20)  // draft/sent/viewed/accepted/rejected
  sentAt          DateTime?                               // 送付日時

  // その他
  assignedTo      String?   @db.VarChar(100)              // 担当者
  note            String?                                 // 備考
  isAutoGenerated Boolean   @default(false)               // 自動生成フラグ

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  stpCompany      StpCompany?            @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  submission      StpLeadFormSubmission? @relation(fields: [submissionId], references: [id])

  @@index([stpCompanyId])
  @@index([submissionId])
  @@map("stp_proposals")
}

// ============================================
// 短縮URL (Short URLs)
// リード獲得フォームURL等の短縮用
// ============================================

model ShortUrl {
  id          Int      @id @default(autoincrement())
  shortCode   String   @unique @db.VarChar(10)    // 短縮コード（6文字英数字）
  originalUrl String   @db.VarChar(500)           // 元のURL
  createdAt   DateTime @default(now())

  @@map("short_urls")
}

// ============================================
// STP KPIシート (STP KPI Sheets)
// 企業ごとの運用KPIシート（1企業に複数作成可能）
// ============================================

model StpKpiSheet {
  id            Int       @id @default(autoincrement())
  stpCompanyId  Int                                    // stp_companiesへの外部キー
  name          String    @db.VarChar(100)             // シート名（自由入力: "Indeed", "Wantedly"等）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  stpCompany    StpCompany          @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  weeklyData    StpKpiWeeklyData[]
  shareLinks    StpKpiShareLink[]

  @@index([stpCompanyId])
  @@map("stp_kpi_sheets")
}

// ============================================
// STP KPI週次データ (STP KPI Weekly Data)
// 週単位の目標値・実績値を管理
// ============================================

model StpKpiWeeklyData {
  id              Int       @id @default(autoincrement())
  kpiSheetId      Int                                     // stp_kpi_sheetsへの外部キー
  weekStartDate   DateTime  @db.Date                      // 週開始日
  weekEndDate     DateTime  @db.Date                      // 週終了日

  // 目標値
  targetImpressions   Int?                                // 表示回数（目標）
  targetCpm           Decimal?  @db.Decimal(10,2)         // 表示単価（目標）
  targetClicks        Int?                                // クリック数（目標）
  targetCtr           Decimal?  @db.Decimal(5,2)          // クリック率（目標）
  targetCpc           Decimal?  @db.Decimal(10,2)         // クリック単価（目標）
  targetApplications  Int?                                // 応募数（目標）
  targetCvr           Decimal?  @db.Decimal(5,2)          // 応募率（目標）
  targetCpa           Decimal?  @db.Decimal(10,2)         // 応募単価（目標）
  targetCost          Int?                                // 費用（目標）

  // 実績値
  actualImpressions   Int?                                // 表示回数（実績）
  actualCpm           Decimal?  @db.Decimal(10,2)         // 表示単価（実績）
  actualClicks        Int?                                // クリック数（実績）
  actualCtr           Decimal?  @db.Decimal(5,2)          // クリック率（実績）
  actualCpc           Decimal?  @db.Decimal(10,2)         // クリック単価（実績）
  actualApplications  Int?                                // 応募数（実績）
  actualCvr           Decimal?  @db.Decimal(5,2)          // 応募率（実績）
  actualCpa           Decimal?  @db.Decimal(10,2)         // 応募単価（実績）
  actualCost          Int?                                // 費用（実績）

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  kpiSheet      StpKpiSheet @relation(fields: [kpiSheetId], references: [id], onDelete: Cascade)

  @@unique([kpiSheetId, weekStartDate])
  @@index([kpiSheetId])
  @@map("stp_kpi_weekly_data")
}

// ============================================
// STP KPI共有リンク (STP KPI Share Links)
// 時間制限付きの公開共有リンク
// ============================================

model StpKpiShareLink {
  id           Int       @id @default(autoincrement())
  kpiSheetId   Int                                     // stp_kpi_sheetsへの外部キー
  token        String    @unique @db.VarChar(64)       // 共有トークン
  expiresAt    DateTime                                // 有効期限
  createdAt    DateTime  @default(now())
  createdBy    Int?                                    // 発行者（master_staffへの外部キー）

  // Relations
  kpiSheet     StpKpiSheet @relation(fields: [kpiSheetId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([kpiSheetId])
  @@map("stp_kpi_share_links")
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 全顧客マスタ (Stella Companies)
// ============================================

model MasterStellaCompany {
  id              Int      @id @default(autoincrement())
  companyCode     String   @unique @db.VarChar(20)  // SC-1, SC-2...
  name            String   @db.VarChar(200)         // 企業名
  nameKana        String?  @db.VarChar(200)         // 企業名フリガナ
  corporateNumber String?  @unique @db.VarChar(13)   // 法人番号（13桁）
  companyType     String?  @db.VarChar(10)          // 区分（法人/個人）
  websiteUrl      String?  @db.VarChar(500)         // 企業HP
  industry        String?  @db.VarChar(100)         // 業界（自由入力）
  revenueScale    String?  @db.VarChar(100)         // 売上規模（自由入力）
  staffId         Int?                              // 担当者（AS）
  leadSource      String?  @db.VarChar(50)          // 流入経路（紹介/Web問い合わせ/テレアポ/展示会/セミナー/代理店）
  note            String?                           // メモ

  // 締め日・支払条件
  closingDay             Int?                              // 締め日（0=月末, 1-28=指定日）
  paymentMonthOffset     Int?                              // 支払月（1=翌月, 2=翌々月, 3=3ヶ月後...）
  paymentDay             Int?                              // 支払日（0=末日, 1-28=指定日）

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 企業統合（マージ）
  mergedIntoId  Int?                              // 統合先企業ID（統合済みの場合）
  mergedAt      DateTime?                         // 統合日時

  // Relations
  staff                MasterStaff?         @relation(fields: [staffId], references: [id])
  mergedInto           MasterStellaCompany? @relation("CompanyMerge", fields: [mergedIntoId], references: [id])
  mergedFrom           MasterStellaCompany[] @relation("CompanyMerge")
  locations            StellaCompanyLocation[]
  contacts             StellaCompanyContact[]
  bankAccounts         StellaCompanyBankAccount[]
  stpCompanies         StpCompany[]
  stpContractHistories StpContractHistory[]
  agentCompanies       StpAgent[]           @relation("AgentCompany")
  referredAgents       StpAgent[]           @relation("ReferrerCompany")
  contracts            MasterContract[]
  contactHistories     ContactHistory[]
  externalUsers        ExternalUser[]
  registrationTokens   RegistrationToken[]

  @@map("master_stella_companies")
}

// ============================================
// 企業拠点 (Stella Company Locations)
// 本社・支社などの拠点情報
// ============================================

model StellaCompanyLocation {
  id         Int       @id @default(autoincrement())
  companyId  Int                                    // MasterStellaCompanyへの外部キー
  name       String    @db.VarChar(100)             // 拠点名（本社、大阪支店など）
  address    String?                                // 住所
  phone      String?   @db.VarChar(50)              // 電話番号
  email      String?   @db.VarChar(255)             // メールアドレス
  isPrimary  Boolean   @default(false)              // 主要拠点フラグ
  note       String?                                // 備考
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?                              // 論理削除日時

  // Relations
  company MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("stella_company_locations")
}

// ============================================
// 企業担当者 (Stella Company Contacts)
// ============================================

model StellaCompanyContact {
  id         Int       @id @default(autoincrement())
  companyId  Int                                    // MasterStellaCompanyへの外部キー
  name       String    @db.VarChar(100)             // 担当者名
  email      String?   @db.VarChar(255)             // メールアドレス
  phone      String?   @db.VarChar(50)              // 電話番号
  department String?   @db.VarChar(100)             // 担当部署
  isPrimary  Boolean   @default(false)              // 主連絡先フラグ
  note       String?                                // 備考
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?                              // 論理削除日時

  // Relations
  company      MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  externalUser ExternalUser?

  @@map("stella_company_contacts")
}

// ============================================
// 企業銀行口座 (Stella Company Bank Accounts)
// ============================================

model StellaCompanyBankAccount {
  id                Int       @id @default(autoincrement())
  companyId         Int                                    // MasterStellaCompanyへの外部キー
  bankName          String    @db.VarChar(100)             // 銀行名
  bankCode          String    @db.VarChar(10)              // 銀行コード
  branchName        String    @db.VarChar(100)             // 支店名
  branchCode        String    @db.VarChar(10)              // 支店コード
  accountNumber     String    @db.VarChar(20)              // 口座番号
  accountHolderName String    @db.VarChar(200)             // 口座名義人
  note              String?                                // メモ
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?                              // 論理削除日時

  // Relations
  company MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("stella_company_bank_accounts")
}

// ============================================
// 代理店マスタ (STP Agents)
// ============================================

model StpAgent {
  id                Int       @id @default(autoincrement())
  companyId         Int                                        // 代理店企業（MasterStellaCompanyへの外部キー）※アプリ層でユニーク制約
  status            String    @db.VarChar(20)                   // アクティブ/非アクティブ/解約
  category1         String    @db.VarChar(20)                   // 代理店/顧問
  contractStatus    String?   @db.VarChar(20)                   // 契約済み/商談済み/未商談/日程調整中
  referrerCompanyId Int?                                        // 紹介者（MasterStellaCompanyへの外部キー）
  note              String?                                     // 代理店メモ
  minimumCases      Int?                                        // 最低件数（顧問のみ）
  agentInitialFee   Int?                                        // 代理店への初期費用
  monthlyFee        Int?                                        // 月額費用
  hearingUrl        String?   @db.VarChar(500)                  // ヒアリングURL

  // 源泉徴収対応
  isIndividualBusiness Boolean  @default(false)                  // 個人事業主フラグ
  withholdingTaxRate   Decimal? @db.Decimal(5,2)                 // デフォルト源泉徴収税率(%)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  company          MasterStellaCompany  @relation("AgentCompany", fields: [companyId], references: [id])
  referrerCompany  MasterStellaCompany? @relation("ReferrerCompany", fields: [referrerCompanyId], references: [id])
  stpCompanies           StpCompany[]
  contracts              StpAgentContract[]
  staffAssignments       StpAgentStaff[]
  leadFormToken          StpLeadFormToken?
  agentContractHistories StpAgentContractHistory[]
  expenseRecords         StpExpenseRecord[]
  invoices               StpInvoice[]

  @@map("stp_agents")
}

// ============================================
// 代理店契約書 (STP Agent Contracts)
// 将来のクラウドサインAPI連携対応
// ============================================

model StpAgentContract {
  id              Int       @id @default(autoincrement())
  agentId         Int
  contractUrl     String                                     // 契約書URL
  signedDate      DateTime? @db.Date                         // 締結日（未締結はnull）
  title           String?   @db.VarChar(200)                 // 契約書タイトル
  externalId      String?   @db.VarChar(100)                 // 外部サービスID（クラウドサイン等）
  externalService String?   @db.VarChar(50)                  // 外部サービス名
  status          String    @default("signed") @db.VarChar(20) // draft/pending/signed/expired
  note            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agent StpAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("stp_agent_contracts")
}

// ============================================
// 代理店担当者 (STP Agent Staff)
// 担当者の複数選択用中間テーブル
// ============================================

model StpAgentStaff {
  id        Int      @id @default(autoincrement())
  agentId   Int
  staffId   Int
  createdAt DateTime @default(now())

  agent StpAgent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  staff MasterStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([agentId, staffId])
  @@map("stp_agent_staff")
}

// ============================================
// 商談ステージマスタ (STP)
// ============================================

model StpStage {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(50)
  displayOrder Int?                                   // NULLable（特殊ステージ用）
  stageType    String   @default("progress") @db.VarChar(20)  // 'progress', 'closed_won', 'closed_lost', 'pending'
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  currentStageCompanies StpCompany[]       @relation("CurrentStage")
  targetStageCompanies  StpCompany[]       @relation("TargetStage")
  fromStageHistories    StpStageHistory[]  @relation("FromStage")
  toStageHistories      StpStageHistory[]  @relation("ToStage")

  @@map("stp_stages")
}

// ============================================
// 接触方法マスタ (Contact Methods) - 全プロジェクト共通
// ============================================

model ContactMethod {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(50)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  contactHistories ContactHistory[]

  @@map("contact_methods")
}

// ============================================
// 流入経路マスタ (STP Lead Sources)
// ============================================

model StpLeadSource {
  id           Int      @id @default(autoincrement())
  name         String   @db.VarChar(100)
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stpCompanies StpCompany[]

  @@map("stp_lead_sources")
}

// ============================================
// 採用ブーストプロジェクト企業 (STP Companies)
// ============================================

model StpCompany {
  id                Int       @id @default(autoincrement())
  companyId         Int                                    // master_stella_companiesへの外部キー
  agentId           Int?                                   // 代理店ID（stp_agentsへの外部キー）

  // ステージ管理
  currentStageId    Int?                                   // 現在のステージ
  nextTargetStageId Int?                                   // ネクストステージコミット
  nextTargetDate    DateTime? @db.Date                     // 次の商談日コミット

  // 日付情報
  leadAcquiredDate     DateTime? @db.Date                  // リード獲得日
  meetingDate          DateTime? @db.Date                  // 初回商談日
  firstKoDate          DateTime? @db.Date                  // 初回KO日
  jobPostingStartDate  String?   @db.VarChar(100)          // 求人掲載開始日（テキスト入力）

  // 進捗・ステータス
  progressDetail    String?                                // 進捗詳細
  forecast          String?   @db.VarChar(20)              // ヨミ（MIN,落とし,MAX,来月,辞退）
  operationStatus   String?   @db.VarChar(20)              // 運用ステータス（テスト1,テスト2）
  lostReason        String?                                // 失注理由

  // 企業情報
  industryType      String?   @db.VarChar(20)              // 業種区分（一般,派遣）
  industry          String?   @db.VarChar(100)             // 業界
  plannedHires      Int?                                   // 採用予定人数
  leadSourceId      Int?                                   // 流入経路（マスタから選択）

  // 契約情報
  contractPlan      String?   @db.VarChar(50)              // 契約プラン（後でロジック構築・自動入力）
  media             String?   @db.VarChar(100)             // 媒体（テキスト入力）
  contractStartDate DateTime? @db.Date                     // 契約開始日（後でロジック構築・自動入力）
  contractEndDate   DateTime? @db.Date                     // 契約終了日（後でロジック構築・自動入力）
  initialFee        Int?                                   // 初期費用（0, 100000, 150000）
  monthlyFee        Int?                                   // 月額
  performanceFee    Int?                                   // 成果報酬単価
  salesStaffId      Int?                                   // 担当営業（Staffから選択）
  operationStaffList String?  @db.VarChar(100)             // 担当運用（複数選択：indeed,運用2等）

  // アカウント情報
  accountId         String?   @db.VarChar(100)             // アカウントID
  accountPass       String?   @db.VarChar(100)             // アカウントPASS

  // リンク情報
  jobInfoFolderLink    String?                             // 求人票/会社情報フォルダリンク
  operationReportLink  String?                             // 運用進捗レポートリンク
  proposalLink         String?                             // 提案書リンク

  // 請求先情報（全顧客マスタの拠点・担当者から選択）
  billingLocationId      Int?                              // 請求先住所（拠点ID）
  billingCompanyName     String?  @db.VarChar(200)         // 請求先企業名
  billingAddress         String?                           // 請求先住所（選択時にコピー）
  billingRepresentative  String?  @db.VarChar(100)         // 請求先担当者ID（カンマ区切りで複数保存）
  paymentTerms           String?  @db.VarChar(100)         // 支払いサイト（自由テキスト・後方互換）

  // その他
  note              String?                                // 企業メモ
  contractNote      String?                                // 契約メモ

  // 検討中専用
  pendingReason       String?                              // 検討中理由
  pendingResponseDate DateTime? @db.Date                   // 回答予定日

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  company             MasterStellaCompany     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  currentStage        StpStage?               @relation("CurrentStage", fields: [currentStageId], references: [id])
  nextTargetStage     StpStage?               @relation("TargetStage", fields: [nextTargetStageId], references: [id])
  agent               StpAgent?               @relation(fields: [agentId], references: [id])
  leadSource          StpLeadSource?          @relation(fields: [leadSourceId], references: [id])
  salesStaff          MasterStaff?            @relation("SalesStaffCompanies", fields: [salesStaffId], references: [id])
  stageHistories      StpStageHistory[]
  contracts           StpCompanyContract[]
  proposals           StpProposal[]
  kpiSheets           StpKpiSheet[]
  candidates          StpCandidate[]
  revenueRecords      StpRevenueRecord[]
  expenseRecords      StpExpenseRecord[]
  commissionOverrides StpAgentCommissionOverride[]
  invoices            StpInvoice[]

  @@map("stp_companies")
}

// ============================================
// STP企業契約書 (STP Company Contracts)
// ============================================

model StpCompanyContract {
  id              Int       @id @default(autoincrement())
  stpCompanyId    Int                                     // stp_companiesへの外部キー
  contractUrl     String?                                 // 契約書URL
  signedDate      DateTime? @db.Date                      // 締結日（未締結はnull）
  title           String?   @db.VarChar(200)              // 契約書タイトル
  externalId      String?   @db.VarChar(100)              // 外部サービスID（クラウドサイン等）
  externalService String?   @db.VarChar(50)               // 外部サービス名
  status          String    @default("draft") @db.VarChar(50) // draft/送付済み/先方情報待ち/signed/expired等
  note            String?                                 // 備考
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  stpCompany StpCompany @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)

  @@map("stp_company_contracts")
}

// ============================================
// 接触履歴 (Contact Histories)
// 全プロジェクト共通の接触履歴を管理
// ============================================

model ContactHistory {
  id                   Int       @id @default(autoincrement())
  companyId            Int       @map("company_id")
  contactDate          DateTime  @map("contact_date")
  contactMethodId      Int?      @map("contact_method_id")
  staffId              Int?      @map("staff_id")
  assignedTo           String?   @db.VarChar(255) @map("assigned_to") // 後方互換のため残存
  customerParticipants String?   @db.VarChar(500) @map("customer_participants")
  meetingMinutes       String?   @map("meeting_minutes")
  note                 String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")

  // Relations
  company       MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactMethod ContactMethod?      @relation(fields: [contactMethodId], references: [id])
  staff         MasterStaff?        @relation(fields: [staffId], references: [id])
  roles         ContactHistoryRole[]
  files         ContactHistoryFile[]

  @@index([companyId], map: "idx_contact_histories_company_id")
  @@index([contactDate], map: "idx_contact_histories_contact_date")
  @@index([deletedAt], map: "idx_contact_histories_deleted_at")
  @@index([staffId], map: "idx_contact_histories_staff_id")
  @@map("contact_histories")
}

// ============================================
// 接触履歴ファイル (Contact History Files)
// 接触履歴に添付されたファイルを管理
// ============================================

model ContactHistoryFile {
  id               Int       @id @default(autoincrement())
  contactHistoryId Int       @map("contact_history_id")
  filePath         String    @db.VarChar(500) @map("file_path")
  fileName         String    @db.VarChar(200) @map("file_name")
  fileSize         Int       @map("file_size")
  mimeType         String    @db.VarChar(100) @map("mime_type")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  contactHistory ContactHistory @relation(fields: [contactHistoryId], references: [id], onDelete: Cascade)

  @@index([contactHistoryId], map: "idx_contact_history_files_contact_history_id")
  @@map("contact_history_files")
}

// ============================================
// 接触履歴ロール (Contact History Roles)
// 接触履歴と顧客種別の中間テーブル
// ============================================

model ContactHistoryRole {
  id               Int      @id @default(autoincrement())
  contactHistoryId Int      @map("contact_history_id")
  customerTypeId   Int      @map("customer_type_id")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  contactHistory ContactHistory @relation(fields: [contactHistoryId], references: [id], onDelete: Cascade)
  customerType   CustomerType   @relation(fields: [customerTypeId], references: [id])

  @@unique([contactHistoryId, customerTypeId])
  @@index([contactHistoryId], map: "idx_contact_history_roles_contact_history_id")
  @@index([customerTypeId], map: "idx_contact_history_roles_customer_type_id")
  @@map("contact_history_roles")
}

// ============================================
// 顧客種別マスタ (Customer Types)
// プロジェクトごとの顧客種別を管理
// ============================================

model CustomerType {
  id           Int      @id @default(autoincrement())
  projectId    Int      @map("project_id")
  name         String   @db.VarChar(50)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  project MasterProject        @relation(fields: [projectId], references: [id])
  roles   ContactHistoryRole[]

  @@unique([projectId, name])
  @@index([projectId], map: "idx_customer_types_project_id")
  @@map("customer_types")
}

// ============================================
// ステージ変更履歴 (STP Stage Histories)
// ============================================

model StpStageHistory {
  id                Int       @id @default(autoincrement())
  stpCompanyId      Int                                        // stp_companiesへの外部キー
  eventType         String    @db.VarChar(20)                  // commit, achieved, recommit, progress, back, cancel, won, lost, suspended, resumed, revived, reason_updated
  fromStageId       Int?                                       // 変更前ステージ
  toStageId         Int?                                       // 変更後ステージ
  targetDate        DateTime? @db.Date                         // 目標日
  recordedAt        DateTime  @default(now())                  // 記録日時
  changedBy         String?   @db.VarChar(100)                 // 変更者
  note              String?                                    // 備考
  isCorrected       Boolean   @default(false)                  // この履歴は修正されたか
  alertAcknowledged Boolean   @default(false)                  // アラートを確認して更新したか

  // 失注・検討中理由
  lostReason    String?                                        // 失注理由
  pendingReason String?                                        // 検討中理由

  // サブタイプ（recommit用: positive, negative, neutral）
  subType       String?   @db.VarChar(20)

  // 論理削除
  isVoided      Boolean   @default(false)                      // 取り消しフラグ
  voidedAt      DateTime?                                      // 取り消し日時
  voidedBy      String?   @db.VarChar(100)                     // 取り消した人
  voidReason    String?                                        // 取り消し理由

  // Relations
  stpCompany StpCompany @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  fromStage  StpStage?  @relation("FromStage", fields: [fromStageId], references: [id])
  toStage    StpStage?  @relation("ToStage", fields: [toStageId], references: [id])

  @@map("stp_stage_histories")
}

// ============================================
// スタッフマスタ (Master Staff)
// 社内スタッフ・担当者管理
// ============================================

model MasterStaff {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(100)                 // 名前
  nameKana     String?   @db.VarChar(100)                 // フリガナ
  email        String?   @unique @db.VarChar(255)         // メールアドレス
  phone        String?   @db.VarChar(20)                  // 電話番号
  contractType String?   @db.VarChar(50)                  // 契約形態（正社員、契約社員、業務委託など）
  loginId      String?   @unique @db.VarChar(100)         // ログインID
  passwordHash         String?   @db.VarChar(255)                 // パスワード（ハッシュ化）
  inviteToken          String?   @unique @db.VarChar(64)          // 招待トークン
  inviteTokenExpiresAt DateTime?                                  // 招待トークン有効期限
  displayOrder         Int       @default(0) @map("display_order") // 表示順
  isActive             Boolean   @default(true)                   // 有効フラグ
  isSystemUser         Boolean   @default(false) @map("is_system_user") // システムユーザーフラグ（UI非表示）
  canEditMasterData    Boolean   @default(false)                  // 固定データ編集権限
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  permissions                 StaffPermission[]
  roleAssignments             StaffRoleAssignment[]
  projectAssignments          StaffProjectAssignment[]
  salesContractHistories      StpContractHistory[]   @relation("SalesStaff")
  operationContractHistories  StpContractHistory[]   @relation("OperationStaff")
  agentAssignments            StpAgentStaff[]
  assignedCompanies           MasterStellaCompany[]
  salesStpCompanies           StpCompany[]           @relation("SalesStaffCompanies")
  contactHistories            ContactHistory[]
  approvedExternalUsers       ExternalUser[]
  issuedRegistrationTokens    RegistrationToken[]
  processedLeadSubmissions    StpLeadFormSubmission[]

  // 会計関連Relations
  approvedRevenueRecords      StpRevenueRecord[]          @relation("RevenueApprover")
  paymentTransactions         StpPaymentTransaction[]
  closedMonths                StpMonthlyClose[]           @relation("MonthCloser")
  reopenedMonths              StpMonthlyClose[]           @relation("MonthReopener")
  financeEditLogs             StpFinanceEditLog[]

  // 会計（横断）Relations
  accountingImportBatches     AccountingImportBatch[]
  accountingReconciliations   AccountingReconciliation[]  @relation("ReconciliationMatcher")
  accountingVerifications     AccountingVerification[]
  acctMonthProjectCloser      AccountingMonthlyClose[]    @relation("AcctMonthProjectCloser")
  acctMonthAcctCloser         AccountingMonthlyClose[]    @relation("AcctMonthAcctCloser")
  acctMonthReopener           AccountingMonthlyClose[]    @relation("AcctMonthReopener")

  // パスワードリセット
  passwordResetTokens         PasswordResetToken[]

  @@map("master_staff")
}

// ============================================
// スタッフ役割種別マスタ (Staff Role Types)
// スタッフが担当できる役割の種別
// ============================================

model StaffRoleType {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)          // 営業, 運用, CS, AS など
  name         String   @db.VarChar(100)                 // 表示名
  description  String?                                   // 説明
  displayOrder Int      @default(0)                      // 表示順
  isActive     Boolean  @default(true)                   // 有効フラグ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  staffAssignments StaffRoleAssignment[]

  @@map("staff_role_types")
}

// ============================================
// スタッフ役割割当 (Staff Role Assignments) - 廃止予定
// 後方互換のため残存、新規はStaffProjectRoleAssignmentを使用
// ============================================

model StaffRoleAssignment {
  id         Int      @id @default(autoincrement())
  staffId    Int
  roleTypeId Int
  createdAt  DateTime @default(now())

  staff    MasterStaff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  roleType StaffRoleType @relation(fields: [roleTypeId], references: [id], onDelete: Cascade)

  @@unique([staffId, roleTypeId])
  @@map("staff_role_assignments")
}

// ============================================
// スタッフプロジェクト割当 (Staff Project Assignments)
// スタッフ×プロジェクトの多対多中間テーブル
// 担当者選択時にプロジェクトで絞り込み可能
// ============================================

model StaffProjectAssignment {
  id        Int      @id @default(autoincrement())
  staffId   Int
  projectId Int
  createdAt DateTime @default(now())

  staff   MasterStaff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  project MasterProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([staffId, projectId])
  @@map("staff_project_assignments")
}

// ============================================
// スタッフ権限 (Staff Permissions)
// プロジェクトごとの閲覧・変更権限を管理
// ============================================

model StaffPermission {
  id              Int      @id @default(autoincrement())
  staffId         Int                                     // master_staffへの外部キー
  projectCode     String   @db.VarChar(50)                // プロジェクトコード（例: stp, stella）
  permissionLevel String   @db.VarChar(20)                // none, view, edit, admin
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  staff MasterStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, projectCode])
  @@map("staff_permissions")
}

// ============================================
// 契約履歴 (STP Contract Histories)
// ============================================

model StpContractHistory {
  id                Int       @id @default(autoincrement())
  companyId         Int                                    // master_stella_companiesへの外部キー
  industryType      String    @db.VarChar(20)              // general（一般）, dispatch（派遣）
  contractPlan      String    @db.VarChar(20)              // monthly（月額）, performance（成果報酬）
  jobMedia          String?   @db.VarChar(50)              // 求人媒体（Indeed, Wantedly等）
  contractStartDate DateTime  @db.Date                     // 契約開始日
  contractEndDate   DateTime? @db.Date                     // 契約終了日（nullの場合アクティブ）
  initialFee        Int                                    // 初期費用（0, 100000, 150000）
  monthlyFee        Int                                    // 月額（契約時点の金額を保存）
  performanceFee    Int                                    // 成果報酬単価（契約時点の金額を保存）
  salesStaffId      Int?                                   // 担当営業（master_staffへの外部キー）
  operationStaffId  Int?                                   // 担当運用（master_staffへの外部キー）
  status            String    @db.VarChar(20)              // active, cancelled, dormant
  note              String?                                // 備考
  operationStatus   String?   @db.VarChar(20)              // 運用ステータス（テスト1,テスト2）
  accountId         String?   @db.VarChar(100)             // アカウントID
  accountPass       String?   @db.VarChar(100)             // アカウントPASS

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?                              // 論理削除日時

  // Relations
  company        MasterStellaCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesStaff     MasterStaff?        @relation("SalesStaff", fields: [salesStaffId], references: [id])
  operationStaff MasterStaff?        @relation("OperationStaff", fields: [operationStaffId], references: [id])
  revenueRecords StpRevenueRecord[]
  expenseRecords StpExpenseRecord[]

  @@map("stp_contract_histories")
}

// ============================================
// プロジェクトマスタ (Master Projects)
// ============================================

model MasterProject {
  id                  Int      @id @default(autoincrement())
  code                String   @unique @db.VarChar(50)   // 権限管理用コード（例: stp, srd, slo）
  name                String   @db.VarChar(100)
  description         String?
  isActive            Boolean  @default(true) @map("is_active")
  displayOrder        Int      @default(0) @map("display_order")
  operatingCompanyId  Int?     @map("operating_company_id")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  operatingCompany   OperatingCompany? @relation(fields: [operatingCompanyId], references: [id])
  contracts          MasterContract[]
  staffAssignments   StaffProjectAssignment[]
  customerTypes      CustomerType[]
  accountingTransactions AccountingTransaction[]
  accountingMonthlyCloses AccountingMonthlyClose[]

  @@map("master_projects")
}

// ============================================
// 運営法人マスタ (Operating Companies)
// プロジェクトを運営する法人の情報を管理
// ============================================

model OperatingCompany {
  id                    Int       @id @default(autoincrement())
  companyName           String    @db.VarChar(200)                    // 法人名
  registrationNumber    String?   @unique @db.VarChar(20)             // 適格請求書発行事業者登録番号（T+13桁）
  postalCode            String?   @db.VarChar(10)                     // 郵便番号
  address               String?                                       // 住所
  representativeName    String?   @db.VarChar(100)                    // 代表者名
  phone                 String?   @db.VarChar(50)                     // 電話番号
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  projects              MasterProject[]
  bankAccounts          OperatingCompanyBankAccount[]

  @@map("operating_companies")
}

// ============================================
// 運営法人銀行口座 (Operating Company Bank Accounts)
// ============================================

model OperatingCompanyBankAccount {
  id                Int       @id @default(autoincrement())
  operatingCompanyId Int                                    // OperatingCompanyへの外部キー
  bankName          String    @db.VarChar(100)             // 銀行名
  bankCode          String    @db.VarChar(10)              // 銀行コード
  branchName        String    @db.VarChar(100)             // 支店名
  branchCode        String    @db.VarChar(10)              // 支店コード
  accountNumber     String    @db.VarChar(20)              // 口座番号
  accountHolderName String    @db.VarChar(200)             // 口座名義人
  note              String?                                // メモ
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?                              // 論理削除日時

  // Relations
  operatingCompany OperatingCompany @relation(fields: [operatingCompanyId], references: [id], onDelete: Cascade)

  @@map("operating_company_bank_accounts")
}

// ============================================
// 契約書ステータスマスタ (Master Contract Statuses)
// ============================================

model MasterContractStatus {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(50)
  displayOrder Int       @default(0) @map("display_order")
  isTerminal   Boolean   @default(false) @map("is_terminal")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  contractsCurrent       MasterContract[]                  @relation("CurrentStatus")
  historiesFrom          MasterContractStatusHistory[]     @relation("FromStatus")
  historiesTo            MasterContractStatusHistory[]     @relation("ToStatus")

  @@map("master_contract_statuses")
}

// ============================================
// 契約書テーブル (Master Contracts)
// ============================================

model MasterContract {
  id                    Int       @id @default(autoincrement())
  companyId             Int       @map("company_id")
  projectId             Int       @map("project_id")
  contractNumber        String?   @db.VarChar(50) @map("contract_number")
  parentContractId      Int?      @map("parent_contract_id")
  contractType          String    @db.VarChar(50) @map("contract_type")
  title                 String    @db.VarChar(200)
  startDate             DateTime? @db.Date @map("start_date")
  endDate               DateTime? @db.Date @map("end_date")
  currentStatusId       Int?      @map("current_status_id")
  targetDate            DateTime? @db.Date @map("target_date")
  signedDate            DateTime? @db.Date @map("signed_date")
  isActive              Boolean   @default(false) @map("is_active")
  signingMethod         String?   @db.VarChar(20) @map("signing_method")
  cloudsignDocumentId   String?   @db.VarChar(100) @map("cloudsign_document_id")
  cloudsignStatus       String?   @db.VarChar(30) @map("cloudsign_status")
  cloudsignSentAt       DateTime? @map("cloudsign_sent_at")
  cloudsignCompletedAt  DateTime? @map("cloudsign_completed_at")
  cloudsignUrl          String?   @db.VarChar(500) @map("cloudsign_url")
  filePath              String?   @db.VarChar(500) @map("file_path")
  fileName              String?   @db.VarChar(200) @map("file_name")
  assignedTo            String?   @db.VarChar(100) @map("assigned_to")
  note                  String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  company               MasterStellaCompany       @relation(fields: [companyId], references: [id])
  project               MasterProject             @relation(fields: [projectId], references: [id])
  currentStatus         MasterContractStatus?     @relation("CurrentStatus", fields: [currentStatusId], references: [id])
  parentContract        MasterContract?           @relation("ContractHierarchy", fields: [parentContractId], references: [id])
  childContracts        MasterContract[]          @relation("ContractHierarchy")
  statusHistories       MasterContractStatusHistory[]

  @@index([companyId], map: "idx_master_contracts_company_id")
  @@index([projectId], map: "idx_master_contracts_project_id")
  @@index([companyId, projectId], map: "idx_master_contracts_company_project")
  @@index([currentStatusId], map: "idx_master_contracts_current_status_id")
  @@index([isActive], map: "idx_master_contracts_is_active")
  @@index([cloudsignDocumentId], map: "idx_master_contracts_cloudsign_document_id")
  @@map("master_contracts")
}

// ============================================
// 契約書ステータス変更履歴 (Master Contract Status Histories)
// ============================================

model MasterContractStatusHistory {
  id           Int       @id @default(autoincrement())
  contractId   Int       @map("contract_id")
  eventType    String    @db.VarChar(30) @map("event_type")
  fromStatusId Int?      @map("from_status_id")
  toStatusId   Int?      @map("to_status_id")
  targetDate   DateTime? @db.Date @map("target_date")
  changedBy    String?   @db.VarChar(100) @map("changed_by")
  note         String?
  recordedAt   DateTime  @default(now()) @map("recorded_at")

  contract     MasterContract             @relation(fields: [contractId], references: [id])
  fromStatus   MasterContractStatus?      @relation("FromStatus", fields: [fromStatusId], references: [id])
  toStatus     MasterContractStatus?      @relation("ToStatus", fields: [toStatusId], references: [id])

  @@index([contractId], map: "idx_master_contract_status_histories_contract_id")
  @@index([recordedAt], map: "idx_master_contract_status_histories_recorded_at")
  @@map("master_contract_status_histories")
}

// ============================================
// 外部ユーザー (External Users)
// クライアント・代理店担当者向けログインアカウント
// ============================================

model ExternalUser {
  id                  Int       @id @default(autoincrement())
  companyId           Int                                      // 所属企業（MasterStellaCompanyへの外部キー）
  registrationTokenId Int?                                     // 登録に使用されたトークン
  contactId           Int?      @unique                        // 担当者情報（任意、StellaCompanyContactへの外部キー）
  name                String    @db.VarChar(100)               // 名前
  position            String?   @db.VarChar(100)               // 役職
  email               String    @unique @db.VarChar(255)       // ログイン用メールアドレス
  passwordHash        String    @db.VarChar(255)               // パスワード（ハッシュ化）
  status              String    @default("pending_email") @db.VarChar(20)  // pending_email/pending_approval/active/suspended
  emailVerifiedAt     DateTime?                                // メール認証日時
  approvedAt          DateTime?                                // 管理者承認日時
  approvedBy          Int?                                     // 承認者（MasterStaffへの外部キー）
  lastLoginAt         DateTime?                                // 最終ログイン日時
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  company                   MasterStellaCompany              @relation(fields: [companyId], references: [id])
  registrationToken         RegistrationToken?               @relation(fields: [registrationTokenId], references: [id])
  contact                   StellaCompanyContact?            @relation(fields: [contactId], references: [id])
  approver                  MasterStaff?                     @relation(fields: [approvedBy], references: [id])
  displayPermissions        ExternalUserDisplayPermission[]
  loginHistories            LoginHistory[]
  emailVerificationTokens   EmailVerificationToken[]
  passwordResetTokens       PasswordResetToken[]

  @@index([companyId])
  @@index([status])
  @@map("external_users")
}

// ============================================
// 表示ビュー定義 (Display Views)
// 外部ユーザー向け画面の定義
// ============================================

model DisplayView {
  id           Int      @id @default(autoincrement())
  viewKey      String   @unique @db.VarChar(50)     // stp_client, stp_agent
  viewName     String   @db.VarChar(100)            // 採用ブースト（クライアント版）
  projectCode  String   @db.VarChar(50)             // stp, stella
  description  String?                              // 説明
  isActive     Boolean  @default(true)              // 有効フラグ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  userPermissions            ExternalUserDisplayPermission[]
  registrationTokenDefaults  RegistrationTokenDefaultView[]

  @@map("display_views")
}

// ============================================
// 外部ユーザー表示権限 (External User Display Permissions)
// ユーザー×ビューの権限管理
// ============================================

model ExternalUserDisplayPermission {
  id             Int      @id @default(autoincrement())
  externalUserId Int
  displayViewId  Int
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)
  displayView  DisplayView  @relation(fields: [displayViewId], references: [id])

  @@unique([externalUserId, displayViewId])
  @@map("external_user_display_permissions")
}

// ============================================
// 登録トークン (Registration Tokens)
// 外部ユーザー登録用の招待トークン
// ============================================

model RegistrationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique @db.VarChar(64)       // 招待トークン
  companyId Int                                     // 対象企業（MasterStellaCompanyへの外部キー）
  name      String?  @db.VarChar(100)              // 管理名（誰向けか等）
  note      String?                                 // 備考
  expiresAt DateTime                                // 有効期限
  maxUses   Int      @default(1)                    // 最大使用回数
  useCount  Int      @default(0)                    // 使用回数
  status    String   @default("active") @db.VarChar(20)  // active/expired/exhausted/revoked
  issuedBy  Int                                     // 発行者（MasterStaffへの外部キー）
  createdAt DateTime @default(now())

  // Relations
  company       MasterStellaCompany            @relation(fields: [companyId], references: [id])
  issuer        MasterStaff                    @relation(fields: [issuedBy], references: [id])
  defaultViews  RegistrationTokenDefaultView[]
  externalUsers ExternalUser[]

  @@index([token])
  @@map("registration_tokens")
}

// ============================================
// 登録トークンデフォルトビュー (Registration Token Default Views)
// トークン発行時に指定するデフォルトの表示権限
// ============================================

model RegistrationTokenDefaultView {
  id                  Int      @id @default(autoincrement())
  registrationTokenId Int
  displayViewId       Int
  createdAt           DateTime @default(now())

  // Relations
  registrationToken RegistrationToken @relation(fields: [registrationTokenId], references: [id], onDelete: Cascade)
  displayView       DisplayView       @relation(fields: [displayViewId], references: [id])

  @@unique([registrationTokenId, displayViewId])
  @@map("registration_token_default_views")
}

// ============================================
// メール認証トークン (Email Verification Tokens)
// メールアドレス確認用トークン
// ============================================

model EmailVerificationToken {
  id             Int      @id @default(autoincrement())
  token          String   @unique @db.VarChar(64)  // 認証トークン
  externalUserId Int                                // 外部ユーザー（ExternalUserへの外部キー）
  expiresAt      DateTime                           // 有効期限
  isUsed         Boolean  @default(false)           // 使用済みフラグ
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

// ============================================
// パスワードリセットトークン (Password Reset Tokens)
// パスワード再設定用トークン
// ============================================

model PasswordResetToken {
  id             Int      @id @default(autoincrement())
  token          String   @unique @db.VarChar(64)  // リセットトークン
  externalUserId Int?                               // 外部ユーザー（ExternalUserへの外部キー）
  staffId        Int?                               // 社内スタッフ（MasterStaffへの外部キー）
  expiresAt      DateTime                           // 有効期限
  isUsed         Boolean  @default(false)           // 使用済みフラグ
  createdAt      DateTime @default(now())

  // Relations
  externalUser ExternalUser? @relation(fields: [externalUserId], references: [id], onDelete: Cascade)
  staff        MasterStaff?  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_reset_tokens")
}

// ============================================
// ログイン履歴 (Login Histories)
// 外部ユーザーのログイン記録
// ============================================

model LoginHistory {
  id             Int      @id @default(autoincrement())
  externalUserId Int                                // 外部ユーザー（ExternalUserへの外部キー）
  loginAt        DateTime @default(now())           // ログイン日時
  ipAddress      String?  @db.VarChar(45)           // IPアドレス
  userAgent      String?                            // ユーザーエージェント
  result         String   @db.VarChar(20)           // success/failure
  failureReason  String?  @db.VarChar(50)           // 失敗理由

  // Relations
  externalUser ExternalUser @relation(fields: [externalUserId], references: [id], onDelete: Cascade)

  @@index([externalUserId])
  @@index([loginAt])
  @@map("login_histories")
}

// ============================================
// STPリード獲得フォームトークン (STP Lead Form Tokens)
// 代理店ごとのユニークフォームURL管理
// ============================================

model StpLeadFormToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique @db.VarChar(64)       // URLトークン
  agentId   Int       @unique                       // 代理店ID（1代理店につき1トークン）
  status    String    @default("active") @db.VarChar(20)  // active/paused/revoked
  expiresAt DateTime?                               // 有効期限（nullは無期限）
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  agent       StpAgent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
  submissions StpLeadFormSubmission[]

  @@index([token])
  @@map("stp_lead_form_tokens")
}

// ============================================
// STPリード獲得フォーム回答 (STP Lead Form Submissions)
// フォーム回答データ
// ============================================

model StpLeadFormSubmission {
  id              Int       @id @default(autoincrement())
  tokenId         Int                                     // フォームトークンへのFK
  stpCompanyId    Int?                                    // 作成されたSTP企業ID
  masterCompanyId Int?                                    // 紐付けられた全顧客マスタID

  // 回答者情報
  companyName     String    @db.VarChar(200)              // 会社名
  contactName     String    @db.VarChar(100)              // 担当者氏名
  contactEmail    String    @db.VarChar(255)              // メールアドレス
  contactPhone    String?   @db.VarChar(50)               // 電話番号

  // 採用実績情報
  pastHiringJobTypes       String?                        // 過去採用経験のある職種（JSON）
  pastRecruitingCostAgency Int?                           // 人材紹介費用（円）
  pastRecruitingCostAds    Int?                           // 求人広告費用（円）
  pastRecruitingCostReferral Int?                         // リファラル費用（円）
  pastRecruitingCostOther  Int?                           // その他費用（円）
  pastHiringCount          Int?                           // 過去採用人数

  // 希望情報
  desiredJobTypes          String?                        // 希望職種（JSON）
  annualBudget             Int?                           // 年間採用予算（円）
  annualHiringTarget       Int?                           // 年間希望採用人数
  hiringAreas              String?                        // 採用エリア（JSON: 都道府県）
  hiringTimeline           String?   @db.VarChar(100)     // 採用希望時期（月）
  ageRangeMin              Int?                           // 採用可能年齢: 下限（旧フォーム互換用）
  ageRangeMax              Int?                           // 採用可能年齢: 上限（旧フォーム互換用）
  ageRange                 String?   @db.VarChar(10)      // 採用可能年齢幅（不問, 〜30, 〜35, etc.）
  requiredConditions       String?                        // 必須条件
  preferredConditions      String?                        // 希望条件

  // メタ情報
  status          String    @default("pending") @db.VarChar(20)  // pending/processed/rejected
  processedAt     DateTime?                               // 処理日時
  processedBy     Int?                                    // 処理者（MasterStaffへのFK）
  processingNote  String?                                 // 処理メモ
  submittedAt     DateTime  @default(now())               // 回答日時
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  token         StpLeadFormToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  processor     MasterStaff?     @relation(fields: [processedBy], references: [id])
  proposals     StpProposal[]

  @@index([tokenId])
  @@index([status])
  @@index([submittedAt])
  @@map("stp_lead_form_submissions")
}

// ============================================
// STP提案書 (STP Proposals)
// ヒアリングフォームからの自動生成および手動作成
// ============================================

model StpProposal {
  id              Int       @id @default(autoincrement())

  // 紐付け（両方nullable、アプリ層でバリデーション）
  stpCompanyId    Int?                                    // STP企業への外部キー
  submissionId    Int?                                    // フォーム回答への外部キー

  // 基本情報
  title           String    @db.VarChar(200)              // 提案書タイトル
  proposalNumber  String?   @db.VarChar(50)               // 提案書番号（自動採番）

  // ファイル情報（PDFアップロード時）
  filePath        String?   @db.VarChar(500)
  fileName        String?   @db.VarChar(200)

  // 外部URL（Canva, Google Docs等）
  externalUrl     String?   @db.VarChar(500)
  externalService String?   @db.VarChar(50)               // canva/google_docs/other

  // ステータス
  status          String    @default("draft") @db.VarChar(20)  // draft/sent/viewed/accepted/rejected
  sentAt          DateTime?                               // 送付日時

  // その他
  assignedTo      String?   @db.VarChar(100)              // 担当者
  note            String?                                 // 備考
  isAutoGenerated Boolean   @default(false)               // 自動生成フラグ

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  stpCompany      StpCompany?            @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  submission      StpLeadFormSubmission? @relation(fields: [submissionId], references: [id])

  @@index([stpCompanyId])
  @@index([submissionId])
  @@map("stp_proposals")
}

// ============================================
// 短縮URL (Short URLs)
// リード獲得フォームURL等の短縮用
// ============================================

model ShortUrl {
  id          Int      @id @default(autoincrement())
  shortCode   String   @unique @db.VarChar(10)    // 短縮コード（6文字英数字）
  originalUrl String   @db.VarChar(500)           // 元のURL
  createdAt   DateTime @default(now())

  @@map("short_urls")
}

// ============================================
// STP KPIシート (STP KPI Sheets)
// 企業ごとの運用KPIシート（1企業に複数作成可能）
// ============================================

model StpKpiSheet {
  id            Int       @id @default(autoincrement())
  stpCompanyId  Int                                    // stp_companiesへの外部キー
  name          String    @db.VarChar(100)             // シート名（自由入力: "Indeed", "Wantedly"等）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  stpCompany    StpCompany          @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  weeklyData    StpKpiWeeklyData[]
  shareLinks    StpKpiShareLink[]

  @@index([stpCompanyId])
  @@map("stp_kpi_sheets")
}

// ============================================
// STP KPI週次データ (STP KPI Weekly Data)
// 週単位の目標値・実績値を管理
// ============================================

model StpKpiWeeklyData {
  id              Int       @id @default(autoincrement())
  kpiSheetId      Int                                     // stp_kpi_sheetsへの外部キー
  weekStartDate   DateTime  @db.Date                      // 週開始日
  weekEndDate     DateTime  @db.Date                      // 週終了日

  // 目標値
  targetImpressions   Int?                                // 表示回数（目標）
  targetCpm           Decimal?  @db.Decimal(10,2)         // 表示単価（目標）
  targetClicks        Int?                                // クリック数（目標）
  targetCtr           Decimal?  @db.Decimal(5,2)          // クリック率（目標）
  targetCpc           Decimal?  @db.Decimal(10,2)         // クリック単価（目標）
  targetApplications  Int?                                // 応募数（目標）
  targetCvr           Decimal?  @db.Decimal(5,2)          // 応募率（目標）
  targetCpa           Decimal?  @db.Decimal(10,2)         // 応募単価（目標）
  targetCost          Int?                                // 費用（目標）

  // 実績値
  actualImpressions   Int?                                // 表示回数（実績）
  actualCpm           Decimal?  @db.Decimal(10,2)         // 表示単価（実績）
  actualClicks        Int?                                // クリック数（実績）
  actualCtr           Decimal?  @db.Decimal(5,2)          // クリック率（実績）
  actualCpc           Decimal?  @db.Decimal(10,2)         // クリック単価（実績）
  actualApplications  Int?                                // 応募数（実績）
  actualCvr           Decimal?  @db.Decimal(5,2)          // 応募率（実績）
  actualCpa           Decimal?  @db.Decimal(10,2)         // 応募単価（実績）
  actualCost          Int?                                // 費用（実績）

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  kpiSheet      StpKpiSheet @relation(fields: [kpiSheetId], references: [id], onDelete: Cascade)

  @@unique([kpiSheetId, weekStartDate])
  @@index([kpiSheetId])
  @@map("stp_kpi_weekly_data")
}

// ============================================
// STP KPI共有リンク (STP KPI Share Links)
// 時間制限付きの公開共有リンク
// ============================================

model StpKpiShareLink {
  id           Int       @id @default(autoincrement())
  kpiSheetId   Int                                     // stp_kpi_sheetsへの外部キー
  token        String    @unique @db.VarChar(64)       // 共有トークン
  expiresAt    DateTime                                // 有効期限
  createdAt    DateTime  @default(now())
  createdBy    Int?                                    // 発行者（master_staffへの外部キー）

  // Relations
  kpiSheet     StpKpiSheet @relation(fields: [kpiSheetId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([kpiSheetId])
  @@map("stp_kpi_share_links")
}

// ============================================
// STP求職者 (STP Candidates)
// 採用ブーストプロジェクトの求職者情報管理
// ============================================

model StpCandidate {
  id                  Int       @id @default(autoincrement())
  lastName            String    @db.VarChar(50)                // 姓
  firstName           String    @db.VarChar(50)                // 名
  interviewDate       DateTime? @db.Date                       // 面接日程
  interviewAttendance String?   @db.VarChar(20)                // 面接参加有無（参加/不参加）
  selectionStatus     String?   @db.VarChar(20)                // 選考状況
  offerDate           DateTime? @db.Date                       // 内定日
  joinDate            DateTime? @db.Date                       // 入社日
  industryType        String?   @db.VarChar(20)                // 業種区分（general/dispatch）
  jobMedia            String?   @db.VarChar(50)                // 求人媒体（Indeed/doda/Wantedly/マイナビ/リクナビ）
  note                String?                                  // メモ書き
  stpCompanyId        Int?                                     // 入社先（STP企業への外部キー）
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  stpCompany          StpCompany? @relation(fields: [stpCompanyId], references: [id])
  revenueRecords      StpRevenueRecord[]

  @@index([stpCompanyId])
  @@map("stp_candidates")
}

// ============================================
// 代理店契約履歴 (STP Agent Contract Histories)
// 代理店との契約条件を期間ごとに管理
// デフォルト報酬率を保持（企業契約作成時に自動セット）
// ============================================

model StpAgentContractHistory {
  id                       Int       @id @default(autoincrement())
  agentId                  Int                                    // 代理店（stp_agentsへの外部キー）
  contractStartDate        DateTime  @db.Date                     // 契約開始日
  contractEndDate          DateTime? @db.Date                     // 契約終了日（null = 現在有効）
  status                   String    @db.VarChar(20)              // "契約前" / "契約済み"

  // 代理店への直接費用
  initialFee               Int?                                   // 初期費用
  monthlyFee               Int?                                   // 月額費用

  // 月額プランを契約した企業からの報酬
  defaultMpInitialRate         Decimal?  @db.Decimal(5,2)         // 初期費用報酬率(%)
  defaultMpInitialDuration     Int?                               // 報酬発生期間(ヶ月)
  defaultMpMonthlyType         String?   @db.VarChar(10)          // "rate" or "fixed"
  defaultMpMonthlyRate         Decimal?  @db.Decimal(5,2)         // 月額報酬率(%)
  defaultMpMonthlyFixed        Int?                               // 月額報酬固定額
  defaultMpMonthlyDuration     Int?                               // 月額報酬発生期間(ヶ月)

  // 成果報酬プランを契約した企業からの報酬
  defaultPpInitialRate         Decimal?  @db.Decimal(5,2)         // 初期費用報酬率(%)
  defaultPpInitialDuration     Int?                               // 報酬発生期間(ヶ月)
  defaultPpPerfType            String?   @db.VarChar(10)          // "rate" or "fixed"
  defaultPpPerfRate            Decimal?  @db.Decimal(5,2)         // 成果報酬率(%)
  defaultPpPerfFixed           Int?                               // 成果報酬固定額
  defaultPpPerfDuration        Int?                               // 報酬発生期間(ヶ月)

  note                     String?                                // 備考
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  deletedAt                DateTime?                              // 論理削除日時

  // Relations
  agent               StpAgent          @relation(fields: [agentId], references: [id], onDelete: Cascade)
  expenseRecords       StpExpenseRecord[]
  commissionOverrides  StpAgentCommissionOverride[]

  @@index([agentId])
  @@index([agentId, contractStartDate])
  @@map("stp_agent_contract_histories")
}

// ============================================
// 代理店企業別報酬例外 (STP Agent Commission Overrides)
// 代理店契約のデフォルト報酬率に対する企業別の例外設定
// ============================================

model StpAgentCommissionOverride {
  id                       Int       @id @default(autoincrement())
  agentContractHistoryId   Int                                    // 代理店契約履歴への外部キー
  stpCompanyId             Int                                    // STP企業への外部キー

  // 月額プラン
  mpInitialRate            Decimal?  @db.Decimal(5,2)             // 初期費用報酬率(%)
  mpInitialDuration        Int?                                   // 報酬発生期間(ヶ月)
  mpMonthlyType            String?   @db.VarChar(10)              // "rate" or "fixed"
  mpMonthlyRate            Decimal?  @db.Decimal(5,2)             // 月額報酬率(%)
  mpMonthlyFixed           Int?                                   // 月額報酬固定額
  mpMonthlyDuration        Int?                                   // 月額報酬発生期間(ヶ月)

  // 成果報酬プラン
  ppInitialRate            Decimal?  @db.Decimal(5,2)             // 初期費用報酬率(%)
  ppInitialDuration        Int?                                   // 報酬発生期間(ヶ月)
  ppPerfType               String?   @db.VarChar(10)              // "rate" or "fixed"
  ppPerfRate               Decimal?  @db.Decimal(5,2)             // 成果報酬率(%)
  ppPerfFixed              Int?                                   // 成果報酬固定額
  ppPerfDuration           Int?                                   // 報酬発生期間(ヶ月)

  note                     String?                                // 備考
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  // Relations
  agentContractHistory     StpAgentContractHistory @relation(fields: [agentContractHistoryId], references: [id], onDelete: Cascade)
  stpCompany               StpCompany              @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)

  @@unique([agentContractHistoryId, stpCompanyId])
  @@index([agentContractHistoryId])
  @@index([stpCompanyId])
  @@map("stp_agent_commission_overrides")
}

// ============================================
// 売上実績 (STP Revenue Records)
// 企業からの入金を1件ずつ管理
// ============================================

model StpRevenueRecord {
  id                  Int       @id @default(autoincrement())
  stpCompanyId        Int                                        // STP企業（stp_companiesへの外部キー）
  contractHistoryId   Int?                                       // どの契約条件に基づくか
  candidateId         Int?                                       // 成果報酬の場合、対象の求職者
  invoiceId           Int?                                       // 紐づく請求書（1つの請求書に複数の売上レコードを紐づけ可能）

  // 売上情報
  revenueType         String    @db.VarChar(20)                  // "initial" / "monthly" / "performance"
  targetMonth         DateTime  @db.Date                         // 対象年月（月初日で統一: 2026-02-01等）
  expectedAmount      Int                                        // 請求金額

  // 入金管理
  status              String    @default("pending") @db.VarChar(20)  // pending/approved/invoiced/paid/overdue/cancelled
  paymentStatus       String?   @db.VarChar(20)                  // null(通常)/partial(一部入金)/completed_different(金額相違あり入金済)
  invoiceDate         DateTime? @db.Date                         // 請求日
  dueDate             DateTime? @db.Date                         // 支払期限
  paidDate            DateTime? @db.Date                         // 着金日
  paidAmount          Int?                                       // 実際の着金額

  // 承認フロー
  approvedAt          DateTime?                                  // 承認日時
  approvedBy          Int?                                       // 承認者（MasterStaffへの外部キー）

  // 会計連携（freee等）準備
  accountingStatus    String    @default("unprocessed") @db.VarChar(20) // unprocessed/processing/processed/skipped
  accountingService   String?   @db.VarChar(30)                  // freee 等
  accountingExternalId String?  @db.VarChar(100)                 // 外部会計ID
  accountingSyncedAt  DateTime?                                 // 会計連携反映日時

  // 税情報
  taxType             String    @default("tax_included") @db.VarChar(20)  // "tax_included"（内税）/ "tax_excluded"（外税）
  taxRate             Int       @default(10)                               // 税率(%)
  taxAmount           Int       @default(0)                                // 税額

  // 自動生成フラグ
  isAutoGenerated     Boolean   @default(false)

  // 元データ変更の追跡（スナップショット方式）
  sourceDataChangedAt   DateTime?                                // 元データが変更された日時
  latestCalculatedAmount Int?                                    // 最新の元データで計算した金額

  note                String?                                    // 備考
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?                                  // 論理削除日時

  // Relations
  stpCompany          StpCompany              @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  contractHistory     StpContractHistory?     @relation(fields: [contractHistoryId], references: [id])
  candidate           StpCandidate?           @relation(fields: [candidateId], references: [id])
  invoice             StpInvoice?             @relation(fields: [invoiceId], references: [id])
  approver            MasterStaff?            @relation("RevenueApprover", fields: [approvedBy], references: [id])
  expenseRecords      StpExpenseRecord[]
  editLogs            StpFinanceEditLog[]     @relation("RevenueEditLogs")
  lineItems           StpInvoiceLineItem[]
  paymentAllocations  StpPaymentAllocation[]
  accountingReconciliations AccountingReconciliation[] @relation("RevenueReconciliation")

  @@index([stpCompanyId])
  @@index([targetMonth])
  @@index([status])
  @@index([stpCompanyId, targetMonth])
  @@index([accountingStatus])
  @@index([invoiceId])
  @@map("stp_revenue_records")
}

// ============================================
// 経費実績 (STP Expense Records)
// 代理店への支払いを1件ずつ管理
// ============================================

model StpExpenseRecord {
  id                       Int       @id @default(autoincrement())
  agentId                  Int                                        // 代理店（stp_agentsへの外部キー）
  stpCompanyId             Int?                                       // 紹介報酬の場合、対象企業
  agentContractHistoryId   Int?                                       // どの代理店契約に基づくか
  contractHistoryId        Int?                                       // どの企業契約に基づくか（紹介報酬の場合）
  revenueRecordId          Int?                                       // どの売上に対する報酬か
  invoiceId                Int?                                       // 紐づく請求書（1つの請求書に複数の経費レコードを紐づけ可能）

  // 経費情報
  expenseType         String    @db.VarChar(30)                  // "agent_initial" / "agent_monthly" / "commission_initial" / "commission_performance" / "commission_monthly"
  targetMonth         DateTime  @db.Date                         // 対象年月（月初日で統一: 2026-02-01等）
  expectedAmount      Int                                        // 支払予定額

  // 報酬率スナップショット（生成時の適用値を記録）
  appliedCommissionRate  Decimal? @db.Decimal(5,2)               // 適用された報酬率(%)
  appliedCommissionType  String?  @db.VarChar(10)                // "rate" or "fixed"

  // 源泉徴収
  isWithholdingTarget    Boolean  @default(false)                // 源泉徴収対象か
  withholdingTaxRate     Decimal? @db.Decimal(5,2)               // 源泉徴収税率（10.21% or 20.42%）
  withholdingTaxAmount   Int?                                    // 源泉徴収税額
  netPaymentAmount       Int?                                    // 差引支払額（expectedAmount - withholdingTaxAmount）

  // 支払管理
  status              String    @default("pending") @db.VarChar(20)  // pending/approved/paid/cancelled
  paymentStatus       String?   @db.VarChar(20)                  // null(通常)/partial(一部支払)/completed_different(金額相違あり支払済)
  approvedDate        DateTime? @db.Date                         // 承認日
  paidDate            DateTime? @db.Date                         // 支払日
  paidAmount          Int?                                       // 実際の支払額

  // 会計連携（freee等）準備
  accountingStatus    String    @default("unprocessed") @db.VarChar(20) // unprocessed/processing/processed/skipped
  accountingService   String?   @db.VarChar(30)                  // freee 等
  accountingExternalId String?  @db.VarChar(100)                 // 外部会計ID
  accountingSyncedAt  DateTime?                                 // 会計連携反映日時

  // 税情報
  taxType             String    @default("tax_included") @db.VarChar(20)  // "tax_included"（内税）/ "tax_excluded"（外税）
  taxRate             Int       @default(10)                               // 税率(%)
  taxAmount           Int       @default(0)                                // 税額

  // 自動生成フラグ
  isAutoGenerated     Boolean   @default(false)

  // 元データ変更の追跡（スナップショット方式）
  sourceDataChangedAt   DateTime?                                // 元データが変更された日時
  latestCalculatedAmount Int?                                    // 最新の元データで計算した金額

  note                String?                                    // 備考
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?                                  // 論理削除日時

  // Relations
  agent                StpAgent                  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  stpCompany           StpCompany?               @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  agentContractHistory StpAgentContractHistory?  @relation(fields: [agentContractHistoryId], references: [id])
  contractHistory      StpContractHistory?       @relation(fields: [contractHistoryId], references: [id])
  revenueRecord        StpRevenueRecord?         @relation(fields: [revenueRecordId], references: [id])
  invoice              StpInvoice?               @relation(fields: [invoiceId], references: [id])
  editLogs             StpFinanceEditLog[]       @relation("ExpenseEditLogs")
  lineItems            StpInvoiceLineItem[]
  paymentAllocations   StpPaymentAllocation[]
  accountingReconciliations AccountingReconciliation[] @relation("ExpenseReconciliation")

  @@index([agentId])
  @@index([stpCompanyId])
  @@index([targetMonth])
  @@index([status])
  @@index([agentId, targetMonth])
  @@index([accountingStatus])
  @@index([invoiceId])
  @@map("stp_expense_records")
}

// ============================================
// 請求書管理 (STP Invoices)
// 自社発行請求書・先方受領請求書を統一管理
// ============================================

model StpInvoice {
  id                  Int       @id @default(autoincrement())

  // 種別: outgoing（自社発行）/ incoming（先方受領）
  direction           String    @db.VarChar(20)

  // 関連先
  stpCompanyId        Int?                                        // 顧客企業
  agentId             Int?                                        // 代理店

  // 適格請求書（インボイス制度）対応
  invoiceType         String    @default("standard") @db.VarChar(20) // "standard"（通常）/ "credit_note"（赤伝）
  originalInvoiceId   Int?                                        // 赤伝の場合、元の請求書ID
  registrationNumber  String?   @db.VarChar(20)                   // 適格請求書発行事業者登録番号（発行時スナップショット）

  // 請求書情報
  invoiceNumber       String?   @db.VarChar(50)                   // 請求書番号（自動採番: INV-YYYYMM-NNNN）
  invoiceDate         DateTime? @db.Date                          // 請求日
  dueDate             DateTime? @db.Date                          // 支払期限
  totalAmount         Int?                                        // 請求金額（税込）
  taxAmount           Int?                                        // 消費税額

  // 税率ごとの合計（インボイス制度対応）
  subtotalByTaxRate   Json?                                       // {"10":{"subtotal":100000,"tax":10000},"8":{"subtotal":50000,"tax":4000}}

  // 源泉徴収（incoming請求書用）
  withholdingTaxAmount Int?                                       // 源泉徴収税額
  netPaymentAmount    Int?                                        // 差引支払額（totalAmount - withholdingTaxAmount）

  // ステータス
  // outgoing: draft → issued → sent → paid
  // incoming: received → approved → paid
  status              String    @default("draft") @db.VarChar(20)

  // ファイル管理
  filePath            String?                                     // 保存ファイルパス
  fileName            String?   @db.VarChar(200)                  // 元ファイル名

  // テンプレート（将来用: PDF自動生成）
  templateId          String?   @db.VarChar(50)                   // 使用テンプレートID
  templateData        Json?                                       // テンプレート埋め込みデータ

  note                String?
  deletedAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations（1:N - 1つの請求書に複数の売上/経費レコードを紐づけ可能）
  stpCompany       StpCompany?          @relation(fields: [stpCompanyId], references: [id], onDelete: Cascade)
  agent            StpAgent?            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  originalInvoice  StpInvoice?          @relation("CreditNoteRelation", fields: [originalInvoiceId], references: [id])
  creditNotes      StpInvoice[]         @relation("CreditNoteRelation")
  revenueRecords   StpRevenueRecord[]
  expenseRecords   StpExpenseRecord[]
  lineItems        StpInvoiceLineItem[]

  @@index([direction])
  @@index([stpCompanyId])
  @@index([agentId])
  @@index([status])
  @@map("stp_invoices")
}

// ============================================
// 売上・経費 編集ログ (STP Finance Edit Logs)
// 自動生成レコードの重要フィールド編集や金額不一致を記録
// ============================================

model StpFinanceEditLog {
  id                Int       @id @default(autoincrement())

  // 対象レコード（どちらか一方）
  revenueRecordId   Int?
  expenseRecordId   Int?

  // 編集内容
  editType          String    @db.VarChar(30)   // "field_change"（重要フィールド変更）/ "amount_mismatch"（金額不一致）
  fieldName         String?   @db.VarChar(50)   // 変更されたフィールド名
  oldValue          String?                     // 変更前の値
  newValue          String?                     // 変更後の値
  reason            String?                     // 変更理由（ユーザー入力）

  // 編集者
  editedBy          Int?                        // 編集者（MasterStaffへの外部キー）

  createdAt         DateTime  @default(now())

  // Relations
  revenueRecord     StpRevenueRecord? @relation("RevenueEditLogs", fields: [revenueRecordId], references: [id])
  expenseRecord     StpExpenseRecord? @relation("ExpenseEditLogs", fields: [expenseRecordId], references: [id])
  editor            MasterStaff?      @relation(fields: [editedBy], references: [id])

  @@index([revenueRecordId])
  @@index([expenseRecordId])
  @@map("stp_finance_edit_logs")
}


// ============================================
// 請求書明細行 (STP Invoice Line Items)
// インボイス制度対応の明細管理 + 税率ごと端数処理
// ============================================

model StpInvoiceLineItem {
  id                Int       @id @default(autoincrement())
  invoiceId         Int                                             // StpInvoiceへの外部キー
  sortOrder         Int       @default(0)                           // 表示順

  // 明細内容
  description       String    @db.VarChar(500)                      // 品目・サービス名
  quantity          Int       @default(1)                           // 数量
  unitPrice         Int                                             // 単価（税抜）
  amount            Int                                             // 小計（税抜）= quantity * unitPrice

  // 税情報（明細行レベル）
  taxRate           Int       @default(10)                          // 適用税率(%)
  taxRateCategory   String    @default("standard") @db.VarChar(20) // "standard"(10%), "reduced"(8%), "exempt"(0%)

  // 紐づけ（売上/経費レコードへの参照。nullの場合は手入力明細）
  revenueRecordId   Int?
  expenseRecordId   Int?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  invoice           StpInvoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  revenueRecord     StpRevenueRecord? @relation(fields: [revenueRecordId], references: [id])
  expenseRecord     StpExpenseRecord? @relation(fields: [expenseRecordId], references: [id])

  @@index([invoiceId])
  @@map("stp_invoice_line_items")
}

// ============================================
// 入出金履歴 (STP Payment Transactions)
// 経理担当者が管理する実際の銀行取引記録
// ============================================

model StpPaymentTransaction {
  id                    Int       @id @default(autoincrement())

  // 取引区分
  direction             String    @db.VarChar(20)                    // "incoming"（入金）/ "outgoing"（出金）

  // 取引情報
  transactionDate       DateTime  @db.Date                           // 取引日
  amount                Int                                          // 取引金額
  counterpartyName      String?   @db.VarChar(200)                   // 取引先名（銀行明細の振込名義人等）
  bankAccountName       String?   @db.VarChar(100)                   // 自社の口座名

  // 勘定科目（経理担当者が入力、将来freee連携用）
  accountCode           String?   @db.VarChar(20)                    // 勘定科目コード
  accountName           String?   @db.VarChar(100)                   // 勘定科目名
  subAccountCode        String?   @db.VarChar(20)                    // 補助科目コード
  subAccountName        String?   @db.VarChar(100)                   // 補助科目名

  // freee連携用予約フィールド
  freeeTransactionId    String?   @db.VarChar(100)                   // freee取引ID
  freeeDealId           String?   @db.VarChar(100)                   // freee取引（税区分含む）ID
  freeeSyncedAt         DateTime?                                     // freee同期日時

  // 源泉徴収
  withholdingTaxAmount  Int?                                          // 源泉徴収税額（経費支払時）

  // 消込ステータス
  status                String    @default("unmatched") @db.VarChar(20) // unmatched/partial/matched/excluded

  // 操作者
  processedBy           Int?                                          // 処理者（MasterStaffへの外部キー）

  note                  String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  // Relations
  processor             MasterStaff?              @relation(fields: [processedBy], references: [id])
  allocations           StpPaymentAllocation[]

  @@index([direction])
  @@index([transactionDate])
  @@index([status])
  @@index([transactionDate, direction])
  @@map("stp_payment_transactions")
}

// ============================================
// 入出金配分 (STP Payment Allocations)
// 入出金履歴と売上/経費レコードのN:N消込マッピング
// ============================================

model StpPaymentAllocation {
  id                    Int       @id @default(autoincrement())
  paymentTransactionId  Int                                          // 入出金履歴への外部キー

  // 配分先（どちらか一方）
  revenueRecordId       Int?                                         // 売上レコードへの外部キー
  expenseRecordId       Int?                                         // 経費レコードへの外部キー

  // 配分金額
  allocatedAmount       Int                                          // この配分で消し込む金額

  note                  String?
  createdAt             DateTime  @default(now())

  // Relations
  paymentTransaction    StpPaymentTransaction @relation(fields: [paymentTransactionId], references: [id], onDelete: Cascade)
  revenueRecord         StpRevenueRecord?     @relation(fields: [revenueRecordId], references: [id])
  expenseRecord         StpExpenseRecord?     @relation(fields: [expenseRecordId], references: [id])

  @@index([paymentTransactionId])
  @@index([revenueRecordId])
  @@index([expenseRecordId])
  @@map("stp_payment_allocations")
}

// ============================================
// 月次締めロック (STP Monthly Closes)
// 過去月のデータ変更を防止する月次締め機能
// ============================================

model StpMonthlyClose {
  id              Int       @id @default(autoincrement())
  targetMonth     DateTime  @db.Date                              // 締め対象月（月初日で統一: 2026-02-01等）
  closedAt        DateTime  @default(now())                       // 締め実行日時
  closedBy        Int                                              // 締め実行者（MasterStaffへの外部キー）
  reopenedAt      DateTime?                                        // 再オープン日時（null = ロック中）
  reopenedBy      Int?                                             // 再オープン者
  reopenReason    String?                                          // 再オープン理由
  note            String?

  // Relations
  closer          MasterStaff  @relation("MonthCloser", fields: [closedBy], references: [id])
  reopener        MasterStaff? @relation("MonthReopener", fields: [reopenedBy], references: [id])

  @@unique([targetMonth])
  @@map("stp_monthly_closes")
}

// ============================================
// 請求書番号採番カウンター (STP Invoice Number Sequences)
// INV-YYYYMM-NNNN形式の自動採番を安全に管理
// ============================================

model StpInvoiceNumberSequence {
  id              Int       @id @default(autoincrement())
  yearMonth       String    @unique @db.VarChar(7)                // "2026-02" 形式
  lastNumber      Int       @default(0)                           // その月の最後の番号
  updatedAt       DateTime  @updatedAt

  @@map("stp_invoice_number_sequences")
}

// ============================================
// 会計取込バッチ (Accounting Import Batches)
// freee/銀行CSVの取込履歴を管理
// ============================================

model AccountingImportBatch {
  id              Int       @id @default(autoincrement())
  source          String    @db.VarChar(20)                      // "freee" / "bank_csv" / "manual"
  sourceService   String?   @db.VarChar(30)                      // "freee", "mufg", "smbc" 等
  fileName        String?   @db.VarChar(500)                     // 取込ファイル名
  periodFrom      DateTime? @db.Date                             // 対象期間（開始）
  periodTo        DateTime? @db.Date                             // 対象期間（終了）
  totalCount      Int       @default(0)                          // 総件数
  newCount        Int       @default(0)                          // 新規取込件数
  duplicateCount  Int       @default(0)                          // 重複スキップ件数
  status          String    @default("processing") @db.VarChar(20) // processing/completed/error
  errorMessage    String?                                        // エラー時の内容
  importedBy      Int                                            // 取込実行者（MasterStaffへの外部キー）
  importedAt      DateTime  @default(now())                      // 取込日時
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  importer        MasterStaff              @relation(fields: [importedBy], references: [id])
  transactions    AccountingTransaction[]

  @@index([source])
  @@index([importedAt])
  @@map("accounting_import_batches")
}

// ============================================
// 会計取引 (Accounting Transactions)
// freee・銀行の入出金データ（実際のお金の動き）
// ============================================

model AccountingTransaction {
  id                    Int       @id @default(autoincrement())
  direction             String    @db.VarChar(10)                  // "incoming"（入金）/ "outgoing"（出金）
  transactionDate       DateTime  @db.Date                         // 取引日
  valueDate             DateTime? @db.Date                         // 決済日・受渡日
  amount                Int                                        // 金額（税込）
  taxAmount             Int?                                       // 消費税額
  counterpartyName      String    @db.VarChar(200)                 // 取引先名（freee/銀行の表記）
  counterpartyCode      String?   @db.VarChar(50)                  // 取引先コード（freee上の管理コード）
  description           String?                                    // 摘要（銀行明細の摘要欄）
  memo                  String?                                    // 社内メモ
  accountCode           String?   @db.VarChar(20)                  // 勘定科目コード
  accountName           String?   @db.VarChar(100)                 // 勘定科目名
  bankAccountName       String?   @db.VarChar(100)                 // 口座名（みずほ普通、UFJ当座 等）

  // データ元
  source                String    @db.VarChar(20)                  // "freee" / "bank_csv" / "manual"
  sourceService         String?   @db.VarChar(30)                  // 具体的なサービス名
  sourceTransactionId   String?   @db.VarChar(100)                 // 外部システムの取引ID
  sourceDealId          String?   @db.VarChar(100)                 // freeeの取引(deal)ID
  importBatchId         Int?                                       // 取込バッチID

  // 消込ステータス
  reconciliationStatus  String    @default("unmatched") @db.VarChar(20) // unmatched/partial/matched/excluded

  // プロジェクト紐付け（判明している場合）
  projectId             Int?                                       // MasterProjectへの外部キー

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  importBatch           AccountingImportBatch?   @relation(fields: [importBatchId], references: [id])
  project               MasterProject?           @relation(fields: [projectId], references: [id])
  reconciliations       AccountingReconciliation[]
  verifications         AccountingVerification[]

  @@index([direction])
  @@index([transactionDate])
  @@index([counterpartyName])
  @@index([reconciliationStatus])
  @@index([projectId])
  @@index([source])
  @@index([sourceTransactionId])
  @@map("accounting_transactions")
}

// ============================================
// 会計消込・照合 (Accounting Reconciliations)
// 会計取引とプロジェクト側レコードのN:N紐付け
// ============================================

model AccountingReconciliation {
  id                    Int       @id @default(autoincrement())
  transactionId         Int                                        // AccountingTransactionへの外部キー
  projectCode           String    @db.VarChar(20)                  // プロジェクトコード（"STP" 等）
  recordType            String    @db.VarChar(20)                  // "revenue" / "expense"
  revenueRecordId       Int?                                       // StpRevenueRecordへの外部キー（売上の場合）
  expenseRecordId       Int?                                       // StpExpenseRecordへの外部キー（経費の場合）
  allocatedAmount       Int                                        // この紐付けで消し込む金額
  note                  String?                                    // 消込時の備考
  matchMethod           String    @default("manual") @db.VarChar(10) // "auto"（自動照合）/ "manual"（手動）
  matchedBy             Int?                                       // 消込実行者（MasterStaffへの外部キー）
  matchedAt             DateTime  @default(now())                  // 消込日時
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  transaction           AccountingTransaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  revenueRecord         StpRevenueRecord?      @relation("RevenueReconciliation", fields: [revenueRecordId], references: [id])
  expenseRecord         StpExpenseRecord?       @relation("ExpenseReconciliation", fields: [expenseRecordId], references: [id])
  matcher               MasterStaff?           @relation("ReconciliationMatcher", fields: [matchedBy], references: [id])

  @@index([transactionId])
  @@index([revenueRecordId])
  @@index([expenseRecordId])
  @@index([projectCode])
  @@map("accounting_reconciliations")
}

// ============================================
// 会計確認 (Accounting Verifications)
// プロジェクト担当と経理のダブルチェック記録
// ============================================

model AccountingVerification {
  id                    Int       @id @default(autoincrement())
  transactionId         Int                                        // AccountingTransactionへの外部キー
  verificationType      String    @db.VarChar(20)                  // "project"（業務発生確認）/ "accounting"（経理確認）
  status                String    @default("pending") @db.VarChar(20) // pending/verified/flagged
  verifiedBy            Int                                        // 確認者（MasterStaffへの外部キー）
  verifiedAt            DateTime?                                  // 確認日時（null = 未確認）
  flagReason            String?                                    // 問題ありの場合の理由
  note                  String?                                    // 確認メモ
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  transaction           AccountingTransaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  verifier              MasterStaff            @relation(fields: [verifiedBy], references: [id])

  @@unique([transactionId, verificationType])
  @@index([verificationType])
  @@index([status])
  @@index([verifiedBy])
  @@map("accounting_verifications")
}

// ============================================
// 会計月次締め (Accounting Monthly Closes)
// プロジェクト横断の月次締め管理
// プロジェクト側の締め確認後、経理が最終締めを行う
// ============================================

model AccountingMonthlyClose {
  id              Int       @id @default(autoincrement())
  targetMonth     DateTime  @db.Date                              // 締め対象月（月初日で統一: 2026-02-01等）
  projectId       Int                                              // プロジェクトID（MasterProjectへの外部キー）
  status          String    @default("open") @db.VarChar(20)      // open/project_closed/accounting_closed
  projectClosedAt   DateTime?                                      // プロジェクト側締め日時
  projectClosedBy   Int?                                           // プロジェクト側締め実行者
  accountingClosedAt DateTime?                                     // 経理側最終締め日時
  accountingClosedBy Int?                                          // 経理側最終締め実行者
  reopenedAt      DateTime?                                        // 再オープン日時
  reopenedBy      Int?                                             // 再オープン者
  reopenReason    String?                                          // 再オープン理由
  note            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project            MasterProject @relation(fields: [projectId], references: [id])
  projectCloser      MasterStaff?  @relation("AcctMonthProjectCloser", fields: [projectClosedBy], references: [id])
  accountingCloser   MasterStaff?  @relation("AcctMonthAcctCloser", fields: [accountingClosedBy], references: [id])
  reopener           MasterStaff?  @relation("AcctMonthReopener", fields: [reopenedBy], references: [id])

  @@unique([targetMonth, projectId])
  @@index([targetMonth])
  @@index([projectId])
  @@index([status])
  @@map("accounting_monthly_closes")
}

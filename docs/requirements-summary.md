# Stella CRM システム 現行要件定義書

**作成日**: 2026年2月9日
**対象システム**: Stella CRM（社内CRMシステム）
**ステータス**: 運用中

---

## 目次

1. [システム概要](#1-システム概要)
2. [システム構成・技術スタック](#2-システム構成技術スタック)
3. [機能一覧](#3-機能一覧)
4. [画面一覧](#4-画面一覧)
5. [データモデル（テーブル一覧）](#5-データモデルテーブル一覧)
6. [業務フロー・ビジネスロジック](#6-業務フロービジネスロジック)
7. [認証・権限管理](#7-認証権限管理)
8. [非機能要件](#8-非機能要件)
9. [今後の拡張予定](#9-今後の拡張予定)

---

## 1. システム概要

### 1.1 目的

複数の社内プロジェクトを横断して顧客情報を一元管理するCRMシステム。プロジェクトごとの商談管理・契約管理・接触履歴管理・財務管理を統合的に行う。

### 1.2 想定規模

| 項目 | 値 |
|------|-----|
| 顧客数 | 約10,000社 |
| 同時アクセス | 約30人（社内スタッフ） |
| プロジェクト数 | 4つ（今後増加予定） |
| 外部ユーザー | クライアント企業担当者、代理店担当者 |

### 1.3 プロジェクト構成

| プロジェクト | 説明 | 対象ユーザー |
|-------------|------|-------------|
| **Stella（全顧客マスタ）** | 全顧客の基本情報を一元管理 | 社内スタッフ全員 |
| **STP（採用ブースト）** | 採用支援サービスの商談・契約・運用管理 | 営業・運用・CS担当 |
| **外部ポータル** | クライアント・代理店向け情報閲覧ポータル | 外部ユーザー |
| **管理画面** | 外部ユーザー管理・登録トークン管理 | 管理者 |

---

## 2. システム構成・技術スタック

### 2.1 アーキテクチャ

```
┌──────────────────────────────────┐
│         クライアント（ブラウザ）      │
└──────────┬───────────────────────┘
           │ HTTPS
┌──────────▼───────────────────────┐
│    Next.js App Router (SSR/RSC)   │
│    ├── Server Components          │
│    ├── Server Actions             │
│    └── API Routes                 │
├───────────────────────────────────┤
│    Prisma ORM                     │
├───────────────────────────────────┤
│    PostgreSQL 15                   │
└───────────────────────────────────┘
```

### 2.2 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| フレームワーク | Next.js (App Router) | 16+ |
| 言語 | TypeScript | - |
| ORM | Prisma | - |
| DB | PostgreSQL | 15 |
| UIライブラリ | Tailwind CSS + shadcn/ui | - |
| 認証 | NextAuth.js | - |
| インフラ | Docker / Docker Compose | - |
| メール送信 | Nodemailer | - |

### 2.3 開発・実行環境

| 環境 | URL |
|------|-----|
| アプリケーション | http://localhost:3000 |
| Prisma Studio（DB確認） | http://localhost:5555 |

---

## 3. 機能一覧

### 3.1 Stella（全顧客マスタ）

| # | 機能 | 説明 |
|---|------|------|
| 1 | 企業情報管理 | 企業の基本情報（企業名、企業コード、法人番号、業界、売上規模、HP等）のCRUD |
| 2 | 企業拠点管理 | 本社・支社等の拠点情報（住所、電話番号、メール）の登録・編集。主要拠点フラグ対応 |
| 3 | 企業担当者管理 | 企業側の担当者情報（名前、メール、電話、部署）の登録・編集。主連絡先フラグ対応 |
| 4 | 企業銀行口座管理 | 銀行口座情報（銀行名、支店名、口座番号、名義人）の登録・編集 |
| 5 | 締め日・支払条件管理 | 締め日（月末 or 指定日）、支払月（翌月・翌々月等）、支払日の設定 |
| 6 | 企業統合（マージ） | 重複企業の統合機能。統合元企業のデータを統合先に移動 |
| 7 | 企業検索 | 企業名、企業コードによる検索。Combobox形式での選択UI |

### 3.2 STP（採用ブースト）プロジェクト

#### 企業管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | STP企業一覧 | Stella企業に紐づくSTP企業情報の一覧表示。インライン編集対応 |
| 2 | STP企業詳細 | 商談ステージ、契約情報、請求先情報、リンク情報等の管理 |
| 3 | ステージ管理 | 専用モーダルでステージ変更。アラートルール（18種）によるバリデーション |
| 4 | 契約書管理 | 企業との契約書のアップロード・ステータス管理（draft/送付済み/signed等） |
| 5 | 運用KPIシート | 媒体ごとの週次KPIデータ管理（表示回数、クリック数、応募数、費用）。自動計算項目（CTR、CPC、CVR、CPA等）。共有リンク発行機能 |
| 6 | 求職者（候補者）管理 | 企業に紐づく求職者の面接参加有無・選考状況の管理 |

#### 代理店管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | 代理店一覧 | 代理店情報の一覧表示。インライン編集対応 |
| 2 | 代理店契約履歴 | 期間ごとの契約条件管理。デフォルト報酬率の設定 |
| 3 | 報酬体系管理 | 月額プラン・成果報酬プラン別の報酬率設定。企業別の報酬例外設定 |
| 4 | 代理店契約書管理 | 契約書URL・締結日・ステータスの管理 |
| 5 | 代理店担当者割当 | 社内スタッフの複数割当（中間テーブル） |
| 6 | 契約ステータス自動計算 | 契約履歴の日付から「契約前/契約済み/契約終了」を自動判定 |

#### 履歴管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | 企業接触履歴 | 企業との接触記録（日付、接触方法、担当者、議事録、ファイル添付） |
| 2 | 代理店接触履歴 | 代理店との接触記録（同上） |
| 3 | ステージ変更履歴 | ステージ遷移の全履歴（イベント種別、変更前後ステージ、理由等） |

#### 財務管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | 売上レコード管理 | 企業×月単位の売上データ管理。グルーピング表示（アコーディオン形式） |
| 2 | 経費レコード管理 | 代理店×月単位の経費データ管理。グルーピング表示 |
| 3 | 請求書生成 | 一括生成（企業×月の未請求レコードをまとめて1請求書）・個別生成 |
| 4 | 請求書管理 | 請求書の一覧・ステータス管理。削除時の紐づきレコード自動クリア |
| 5 | 契約履歴管理 | 企業ごとの契約条件（プラン、媒体、期間、金額、担当者）の履歴管理 |

#### リード獲得

| # | 機能 | 説明 |
|---|------|------|
| 1 | リード獲得フォーム | 代理店ごとのユニークURLで公開フォームを提供。2ページ制（基本情報→採用予定） |
| 2 | フォーム回答管理 | 回答一覧の確認。3シナリオ分岐処理（新規企業登録/既存STP企業紐付け/既存Stella企業+STP新規登録） |

#### ダッシュボード

| # | 機能 | 説明 |
|---|------|------|
| 1 | STPダッシュボード | ステージ別企業数、商談進捗状況の可視化 |

### 3.3 マスタ管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | 商談ステージマスタ | ステージ名・表示順・種別（progress/closed_won/closed_lost/pending）の管理 |
| 2 | 接触方法マスタ | 電話・メール・訪問・Web会議等の接触方法管理（全プロジェクト共通） |
| 3 | 流入経路マスタ | リード獲得経路の管理 |
| 4 | 顧客種別マスタ | プロジェクトごとの顧客種別管理 |
| 5 | 契約書ステータスマスタ | 契約書のステータス選択肢管理 |
| 6 | プロジェクトマスタ | プロジェクト情報（コード、名称、運営法人）の管理 |
| 7 | 運営法人マスタ | 法人情報（法人名、登録番号、住所、代表者、振込先）の管理 |
| 8 | 役割種別マスタ | スタッフの役割種別（営業、運用、CS等）の管理 |

### 3.4 スタッフ管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | スタッフ一覧 | 社内スタッフの登録・編集。契約形態（正社員/契約社員/業務委託）管理 |
| 2 | 招待機能 | メールによる招待 → パスワード設定 → ログイン可能（承認不要） |
| 3 | プロジェクト割当 | スタッフ×プロジェクトの多対多割当 |
| 4 | 権限管理 | プロジェクトごとの閲覧・編集・管理権限（none/view/edit/admin） |

### 3.5 外部ユーザー管理

| # | 機能 | 説明 |
|---|------|------|
| 1 | 外部ユーザー一覧 | クライアント・代理店担当者のアカウント管理 |
| 2 | 承認待ちユーザー | メール認証済み・管理者承認待ちユーザーの承認処理 |
| 3 | 登録トークン管理 | 招待URL用トークンの発行・管理。最大使用回数・有効期限設定 |

### 3.6 外部ポータル

| # | 機能 | 説明 |
|---|------|------|
| 1 | クライアント向けポータル | STPクライアント企業担当者向けの情報閲覧画面 |
| 2 | 代理店向けポータル | STP代理店担当者向けの情報閲覧画面 |
| 3 | 表示ビュー制御 | ユーザーごとに閲覧可能なビューを権限で制御 |

### 3.7 契約書管理（プロジェクト横断）

| # | 機能 | 説明 |
|---|------|------|
| 1 | 契約書CRUD | 企業×プロジェクト単位の契約書管理。親子契約（階層構造）対応 |
| 2 | ステータス管理 | ステータス変更履歴の自動記録 |
| 3 | クラウドサイン連携 | 外部電子契約サービスとの連携準備（ID、ステータス、URL管理） |
| 4 | ファイル管理 | 契約書ファイルのアップロード・管理 |

### 3.8 会計管理（プロジェクト横断）

| # | 機能 | 説明 |
|---|------|------|
| 1 | 会計取込バッチ | 会計データの一括取込 |
| 2 | 会計取引管理 | プロジェクト別の会計取引データ管理 |
| 3 | 消込・照合 | 売上/経費レコードと会計取引の照合 |
| 4 | 確認処理 | 会計データの確認ワークフロー |
| 5 | 月次締め | プロジェクト×月単位の締め処理 |

---

## 4. 画面一覧

### 4.1 社内向け画面

```
/                                        → ダッシュボード

# Stella（全顧客マスタ）
/companies                               → 全顧客一覧
/companies/new                           → 全顧客新規登録
/companies/[id]                          → 全顧客詳細
/companies/[id]/edit                     → 全顧客編集

# STPプロジェクト
/stp/dashboard                           → STPダッシュボード
/stp/companies                           → STP企業一覧（ステージ管理ボタン付き）
/stp/companies/[id]/kpi                  → 運用KPIシート管理
/stp/contracts                           → STP契約管理
/stp/lead-submissions                    → リード獲得フォーム回答一覧
/stp/agents                              → 代理店一覧
/stp/candidates                          → 求職者（候補者）一覧

# STP履歴管理
/stp/records/company-contacts            → 企業接触履歴一覧
/stp/records/agent-contacts              → 代理店接触履歴一覧
/stp/records/stage-histories             → ステージ変更履歴一覧

# STPマスタ管理
/stp/settings/stages                     → 商談ステージマスタ
/stp/settings/contact-methods            → 接触方法マスタ（STP専用）

# 全体設定
/settings/contact-methods                → 接触方法マスタ（全体共通）
/settings/contract-statuses              → 契約書ステータスマスタ
/settings/customer-types                 → 顧客種別マスタ
/settings/projects                       → プロジェクトマスタ
/settings/operating-companies            → 運営法人マスタ

# スタッフ管理
/staff                                   → スタッフ一覧
/staff/role-types                        → 役割種別マスタ

# 管理画面（外部ユーザー管理）
/admin/users                             → 外部ユーザー一覧
/admin/pending-users                     → 承認待ちユーザー
/admin/registration-tokens               → 登録トークン管理
```

### 4.2 外部ユーザー向け画面

```
# 外部ポータル
/portal/stp/client                       → クライアント向けポータル
/portal/stp/agent                        → 代理店向けポータル

# 公開フォーム
/form/stp-lead/[token]                   → STPリード獲得フォーム

# 認証関連
/login                                   → ログイン
/register/[token]                        → 外部ユーザー登録
/forgot-password                         → パスワードリセット申請
/reset-password/[token]                  → パスワードリセット
/verify-email/[token]                    → メール認証

# その他
/s/[code]                                → 短縮URLリダイレクト
/s/kpi/[token]                           → KPIシート共有ページ（公開・時間制限付き）
```

---

## 5. データモデル（テーブル一覧）

### 5.1 全顧客マスタ系（4テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| master_stella_companies | 全顧客マスタ | 全プロジェクト共通の企業基本情報 |
| stella_company_locations | 企業拠点 | 本社・支社等の拠点情報、請求先住所の選択元 |
| stella_company_contacts | 企業担当者 | 企業側担当者情報、請求先担当者の選択元 |
| stella_company_bank_accounts | 企業銀行口座 | 振込先口座情報 |

### 5.2 STPプロジェクト系（16テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| stp_companies | STP企業 | 商談・契約・請求先情報の管理 |
| stp_agents | 代理店マスタ | 代理店の基本情報・ステータス管理 |
| stp_agent_contracts | 代理店契約書 | 代理店との契約書管理 |
| stp_agent_staff | 代理店担当者（中間） | 代理店×スタッフの割当 |
| stp_agent_contract_histories | 代理店契約履歴 | 期間ごとの契約条件・報酬率 |
| stp_agent_commission_overrides | 企業別報酬例外 | デフォルト報酬率の企業別例外 |
| stp_stages | 商談ステージマスタ | リード→商談化→提案中→見積提示→受注/失注/検討中 |
| stp_lead_sources | 流入経路マスタ | リード獲得経路の選択肢 |
| stp_stage_histories | ステージ変更履歴 | ステージ遷移の全記録 |
| stp_company_contracts | STP企業契約書 | 企業との契約書管理 |
| stp_contract_histories | 契約履歴 | 企業ごとの契約条件の履歴 |
| stp_candidates | 求職者（候補者） | 面接参加有無・選考状況 |
| stp_kpi_sheets | KPIシート | 媒体ごとのKPI管理 |
| stp_kpi_weekly_data | KPI週次データ | 週単位の目標値・実績値 |
| stp_kpi_share_links | KPI共有リンク | 時間制限付き公開URL |
| stp_lead_form_submissions | リード獲得フォーム回答 | 公開フォームからの回答データ |

### 5.3 スタッフ・権限系（5テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| master_staff | スタッフマスタ | 社内スタッフ情報・ログイン認証 |
| staff_role_types | 役割種別マスタ | 営業、運用、CS等の役割定義 |
| staff_role_assignments | 役割割当（廃止予定） | 旧方式の役割割当 |
| staff_project_assignments | プロジェクト割当 | スタッフ×プロジェクトの割当 |
| staff_permissions | スタッフ権限 | プロジェクトごとの権限レベル |

### 5.4 共通マスタ系（6テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| contact_methods | 接触方法マスタ | 電話・メール・訪問・Web会議等 |
| contact_histories | 接触履歴 | 全プロジェクト共通の接触記録 |
| contact_history_roles | 接触履歴ロール（中間） | 接触履歴×顧客種別の紐付け |
| contact_history_files | 接触履歴ファイル | 接触履歴への添付ファイル |
| customer_types | 顧客種別マスタ | プロジェクトごとの顧客種別 |
| master_projects | プロジェクトマスタ | プロジェクト情報 |
| operating_companies | 運営法人マスタ | プロジェクト運営法人情報 |

### 5.5 契約書管理系（3テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| master_contracts | 契約書 | プロジェクト横断の契約書管理 |
| master_contract_statuses | 契約書ステータスマスタ | ステータス選択肢 |
| master_contract_status_histories | ステータス変更履歴 | ステータス遷移の記録 |

### 5.6 外部ユーザー系（8テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| external_users | 外部ユーザー | クライアント・代理店の担当者アカウント |
| display_views | 表示ビュー定義 | ポータル画面の定義 |
| external_user_display_permissions | 表示権限（中間） | ユーザー×ビューの権限 |
| registration_tokens | 登録トークン | 招待URL用トークン |
| registration_token_default_views | デフォルトビュー（中間） | トークン×ビューの紐付け |
| email_verification_tokens | メール認証トークン | メールアドレス確認用 |
| password_reset_tokens | パスワードリセットトークン | パスワード再設定用 |
| login_histories | ログイン履歴 | 外部ユーザーのログイン記録 |

### 5.7 会計管理系（5テーブル）

| テーブル名 | 説明 | 主な用途 |
|-----------|------|---------|
| accounting_import_batches | 会計取込バッチ | 会計データの一括取込管理 |
| accounting_transactions | 会計取引 | プロジェクト別の会計取引 |
| accounting_reconciliations | 消込・照合 | 売上/経費と会計取引の照合 |
| accounting_verifications | 会計確認 | 確認ワークフロー |
| accounting_monthly_closes | 月次締め | プロジェクト×月の締め処理 |

### 5.8 ER図（概念レベル）

```
                    ┌──────────────────────┐
                    │ MasterStellaCompany  │
                    │   （全顧客マスタ）     │
                    └──────┬───────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         ▼                 ▼                 ▼
   ┌───────────┐    ┌───────────┐    ┌───────────┐
   │ Locations │    │ Contacts  │    │BankAccounts│
   │ （拠点）   │    │（担当者）  │    │（銀行口座） │
   └───────────┘    └───────────┘    └───────────┘
         │                 │
         ▼                 ▼
   ┌─────────────────────────────────────────────┐
   │              STP プロジェクト系               │
   │                                              │
   │  StpCompany ←→ StpAgent                     │
   │     │              │                         │
   │     ├─ StageHistories  ├─ ContractHistories  │
   │     ├─ Contracts       ├─ CommissionOverrides│
   │     ├─ KpiSheets       ├─ AgentContracts     │
   │     ├─ Candidates      └─ AgentStaff         │
   │     └─ RevenueRecords                        │
   │                                              │
   │  StpStage（ステージマスタ）                    │
   │  StpLeadSource（流入経路マスタ）               │
   └─────────────────────────────────────────────┘
         │
         ▼
   ┌─────────────────────────────────────────────┐
   │              共通系                           │
   │  ContactHistory ← ContactMethod              │
   │  MasterStaff ← StaffPermission               │
   │  MasterContract ← ContractStatusHistory      │
   │  ExternalUser ← RegistrationToken            │
   └─────────────────────────────────────────────┘
```

---

## 6. 業務フロー・ビジネスロジック

### 6.1 商談ステージ遷移

#### ステージ定義

| ID | ステージ名 | 種別 | 説明 |
|----|-----------|------|------|
| 1 | リード | 進行 | 見込み顧客の初期段階 |
| 2 | 商談化 | 進行 | 商談が開始された段階 |
| 3 | 提案中 | 進行 | 提案書を提出した段階 |
| 4 | 見積提示 | 進行 | 見積書を提示した段階 |
| 5 | 受注 | 終了（受注） | 契約成立 |
| 6 | 失注 | 終了（失注） | 契約不成立 |
| 7 | 検討中 | 保留 | 顧客が検討中の状態 |

#### イベント種別

| イベント | 意味 | 発生タイミング |
|---------|------|---------------|
| commit | 新規目標設定 | 目標がない状態から新しく目標を設定 |
| achieved | 目標達成 | 現在のステージが目標ステージに到達 |
| recommit | 目標変更 | 目標ステージまたは目標日を変更 |
| progress | 前進 | 目標とは関係なくステージが前に進んだ |
| back | 後退 | 現在のステージが前のステージに戻った |
| cancel | 目標取消 | 目標を達成せずに削除 |
| won | 受注 | 受注ステージへの遷移 |
| lost | 失注 | 失注ステージへの遷移 |
| suspended | 保留 | 検討中ステージへの遷移 |
| resumed | 再開 | 検討中から通常ステージへ復帰 |
| revived | 復活 | 失注から通常ステージへ復帰 |

#### アラートルール

ステージ変更時に18種類のアラートルールでバリデーションを実行。

| 深刻度 | 動作 |
|--------|------|
| ERROR | 保存ブロック、修正必須 |
| WARNING | 警告表示、確認後に保存可能（一部は理由入力必須） |
| INFO | 情報表示、そのまま保存可能 |

### 6.2 リード獲得フロー

```
1. 管理者が代理店ごとにフォームURL（トークン付き）を発行
2. 代理店がクライアント候補にフォームURLを共有
3. クライアント候補がフォーム入力・送信（2ページ制）
   - ページ1: 基本情報 + 採用実績
   - ページ2: 今後の採用予定（職種はページ1から自動反映・変更不可）
4. 管理画面で回答を確認
5. 3シナリオで処理
   a. 新規企業として登録（Stella + STP同時登録）
   b. 既存STP登録済み企業に紐付け（情報更新なし）
   c. 既存Stella企業に紐付け + STP新規登録
```

### 6.3 代理店報酬体系

```
紹介企業に対する報酬の決定:
  1. 該当企業に対する CommissionOverride（例外）が存在するか？
     ├── YES → 例外の報酬設定を適用
     └── NO  → 契約履歴のデフォルト報酬を適用

報酬は2系統:
  ├── 月額プラン（Mp）を契約した企業からの報酬
  │   ├── 初期費用報酬: 率(%) × 期間(ヶ月)
  │   └── 月額報酬: 率(%) or 固定額 × 期間(ヶ月)
  └── 成果報酬プラン（Pp）を契約した企業からの報酬
      ├── 初期費用報酬: 率(%) × 期間(ヶ月)
      └── 成果報酬: 率(%) or 固定額 × 期間(ヶ月)
```

### 6.4 売上・経費と請求書

```
売上レコード → 企業×月でグルーピング → 一括/個別で請求書生成
経費レコード → 代理店×月でグルーピング → 請求書と紐付け

請求書（StpInvoice）
├── 1:N → 売上レコード（StpRevenueRecord）
└── 1:N → 経費レコード（StpExpenseRecord）
```

### 6.5 KPI管理

```
STP企業
└── KPIシート（媒体別: Indeed, Wantedly等）
    └── 週次データ
        ├── 手入力: 表示回数、クリック数、応募数、費用
        └── 自動計算: CPM, CTR, CPC, CVR, CPA
    └── 差分: 実績 - 目標（正=緑/目標超過、負=赤/未達）
```

---

## 7. 認証・権限管理

### 7.1 社内スタッフ認証

| 項目 | 内容 |
|------|------|
| 認証方式 | NextAuth.js + Credentials Provider |
| テーブル | master_staff |
| パスワード | bcryptハッシュ化 |
| 登録フロー | 管理者がスタッフ登録 → 招待メール → パスワード設定 → ログイン可能（承認不要） |

#### 権限レベル

| レベル | 説明 |
|--------|------|
| none | アクセス不可 |
| view | 閲覧のみ |
| edit | 閲覧 + 編集 |
| admin | 全機能利用可 |

### 7.2 外部ユーザー認証

| 項目 | 内容 |
|------|------|
| 認証方式 | NextAuth.js + Credentials Provider |
| テーブル | external_users |
| パスワード | bcryptハッシュ化 |
| 登録フロー | 管理者がトークン発行 → ユーザー登録 → メール認証 → 管理者承認 → ログイン可能 |

#### ユーザーステータス

| ステータス | 説明 |
|-----------|------|
| pending_email | メール認証待ち |
| pending_approval | 管理者承認待ち |
| active | アクティブ（ログイン可能） |
| suspended | 停止中 |

### 7.3 アクセス制御

- ミドルウェアで保護されたルートへのアクセスを制御
- 外部ユーザーは表示ビュー（DisplayView）による画面単位のアクセス制御
- 社内スタッフはプロジェクトコード単位の権限制御
- 公開ページ（フォーム、KPI共有、パスワード設定等）は認証不要

---

## 8. 非機能要件

### 8.1 データ管理

| 項目 | 方針 |
|------|------|
| 削除方式 | 論理削除（deletedAt）を基本とする |
| 履歴管理 | ステージ変更、契約ステータス変更は自動で履歴記録 |
| 論理削除取消 | 一部テーブル（StpStageHistory）はisVoidedフラグによる取消対応 |

### 8.2 UI/UX

| 項目 | 方針 |
|------|------|
| テーブル表示 | インライン編集対応の汎用CRUDテーブルコンポーネント |
| 日付入力 | react-datepicker使用（HTML input[type="date"]は不使用） |
| 企業選択 | 検索可能なCombobox形式 |
| 金額表示 | ¥#,##0 形式（フォーカス時は数値入力、ブラー時はフォーマット表示） |
| 長文編集 | Textarea / モーダル形式。高さ制限 + スクロール |

### 8.3 セキュリティ

| 項目 | 方針 |
|------|------|
| パスワード | bcryptハッシュ化 |
| トークン | 64文字ランダム生成、有効期限付き |
| セッション管理 | NextAuth.jsによるセッション管理 |
| メール認証 | 外部ユーザー登録時に必須 |

### 8.4 インフラ

| 項目 | 方針 |
|------|------|
| コンテナ化 | Docker / Docker Compose |
| DB | PostgreSQL 15（Dockerコンテナ） |
| マイグレーション | Prisma Migrate（`prisma db push`は使用禁止） |

---

## 9. 今後の拡張予定

| 拡張内容 | 概要 | 優先度 |
|---------|------|--------|
| 別プロジェクト追加 | 新規プロジェクト（SRD、SLO等）の追加 | 中 |
| 分析ダッシュボード | KPI集計・商談分析の可視化 | 中 |
| 通知自動化 | ステージ変更・期限通知のメール自動送信 | 低 |
| クラウドサイン連携 | 電子契約サービスとのAPI連携 | 低 |
| 求人媒体API連携 | Indeed等の媒体とのデータ連携 | 低 |

---

## 付録

### A. 選択肢一覧

```
ヨミ（forecast）: MIN, 落とし, MAX, 来月, 辞退
運用ステータス: テスト1, テスト2
業種区分: 一般, 派遣
初期費用: 0, 100,000, 150,000
イベント種別: commit, achieved, recommit, progress, back, cancel, won, lost, suspended, resumed, revived, reason_updated
企業契約書ステータス: draft, 送付済み, 先方情報待ち, signed, expired
外部ユーザーステータス: pending_email, pending_approval, active, suspended
登録トークンステータス: active, expired, exhausted, revoked
リード回答ステータス: pending, processed, rejected
面接参加有無: 参加, 不参加
選考状況: 面接日調整中, 面接日決定, 選考中, 内定, 内定承諾, 辞退, 不合格
代理店ステータス: アクティブ, 休止, 解約
代理店区分: 代理店, 顧問
スタッフ権限レベル: none, view, edit, admin
ステージ種別: progress, closed_won, closed_lost, pending
```

### B. 接触方法マスタ（初期データ）

| ID | 名称 |
|----|------|
| 1 | 電話 |
| 2 | メール |
| 3 | 訪問 |
| 4 | Web会議 |
| 5 | その他 |

### C. 商談ステージマスタ（初期データ）

| ID | 名称 | 種別 |
|----|------|------|
| 1 | リード | 進行 |
| 2 | 商談化 | 進行 |
| 3 | 提案中 | 進行 |
| 4 | 見積提示 | 進行 |
| 5 | 受注 | 終了（受注） |
| 6 | 失注 | 終了（失注） |
| 7 | 検討中 | 保留 |

# Stella基幹OS 外販可能性に関する技術的見解

> 作成日: 2025年2月
> 対象: CRM機能を含んだ基幹OSの外販検討

---

## はじめに：横展開の前提整理

まず大前提として、**現在のstella-crmは「Stella社の事業モデルに完全に最適化された専用システム」です。**

具体的には：

- **STP事業（採用ブースト）の業務フローがDBの設計レベルで組み込まれている**（商談ステージ、代理店管理、KPIシート、報酬計算ロジックなど）
- データベースは約30テーブルあり、その大半がSTP事業固有のもの
- ビジネスロジック（売上計上条件、ステージ遷移ルール等）もコードに直接実装されている

つまり、**「CRM」という汎用的な枠組みではなく、「Stella社のSTP事業を回すためのOS」として作っています。**

これは悪いことではなく、むしろ正しい設計です。事業に最適化しているからこそ、今の使いやすさと開発速度が実現できています。ただし、この事実が横展開を考える上での出発点になります。

---

## ① 他社へ卸す場合の工数について

**結論：現在の設計のまま「そのまま卸す」のは現実的ではありません。**

理由は明確で、他社には他社のビジネスモデルがあり、管理すべきデータ、KPI、ワークフローがすべて異なるためです。今のシステムは「企業→商談→契約→売上」というSTP事業の流れがDB構造の根幹に入っています。異業種であれば、この根幹自体が変わります。

**ただし、「技術資産の再利用」という観点では価値があります。**

### 再利用できる部分（全体の約30〜40%）

- 認証・権限管理の仕組み（3層防御構造）
- 顧客企業マスタ管理
- スタッフ管理・プロジェクト管理
- 外部ユーザーポータルの枠組み
- 接触履歴管理
- UIコンポーネント（テーブル、フォーム、モーダル等）

### 毎回カスタム開発が必要な部分（約60〜70%）

- 業種固有のデータ構造（テーブル設計）
- ワークフロー/ステージ定義
- KPI・レポート設計
- 売上計上・請求ロジック
- 外部システム連携

### 他社向けに作る場合の工数感

| フェーズ | 作業内容 | 想定工数 |
|---|---|---|
| **共通基盤の切り出し（初回のみ）** | 再利用可能な部分をライブラリ化 | 1〜2人月 |
| **1社あたりの個別開発（毎回）** | 要件ヒアリング→DB設計→実装→テスト→導入 | 1〜3人月/社 |

つまり「パッケージを売る」ではなく、**「技術基盤を持った上での受託開発」**に近い形になります。

### 工数が増減する主な要因

- **増える要因：** 独自のワークフロー設計、既存システムとのAPI連携、複雑な権限パターン、独自帳票フォーマット
- **減る要因：** 標準機能のそのまま利用、項目名の変更のみ、類似業種（特に人材業界）

---

## ② マルチテナント化の可否

**結論：いいえ。マルチテナント化は、このシステムには適していません。**

「マルチテナント」とは、SlackやNotionのように**同じ機能を複数社が共有する**仕組みです。これが成立するのは、**どの会社でも使い方がほぼ同じ**場合に限られます。

- チャットツール（Slack等）→ どの会社も「メッセージを送る」は同じ → マルチテナント向き
- CRM（業務基幹システム）→ 会社ごとにビジネスモデルが違う → マルチテナント不向き

stella-crmは後者です。以下の要素が**すべて事業固有**です：

- どのデータとどのデータを紐付けるか（DB構造そのもの）
- どういう条件で売上が発生するか（ビジネスロジック）
- 何をKPIとして管理するか
- どんなステージ/ワークフローで業務が進むか

これらが会社ごとに違う以上、「共通のシステムに入れる」こと自体に意味がありません。無理にマルチテナント化すると、共通化できない部分の方が多く、基盤開発のコストに見合わない結果になります。

### 唯一マルチテナントが成立するパターン

Stella社とまったく同じ事業モデル（採用ブースト事業）で、同じKPI・同じ売上ロジック・同じ管理項目の会社が複数ある場合。ただし現実的にはほぼあり得ないため、検討不要と考えます。

### プラットフォーム型という選択肢について

kintoneやSalesforceのように、ユーザーがUI上でテーブルや項目を自由に定義できるシステムを作る方向性もあります。しかしこれは**「CRMを作る」のではなく「CRMを作るためのシステムを作る」**という話になり、実質的に全く別のプロダクト開発（6人月以上、競合はkintone/Salesforce）になるため、現実的ではありません。

---

## ③ 複数チームでの並行開発構造

**現在の構成でも、ある程度の並行開発は可能です。**

現在のNext.js App Routerの構造は、機能ごとにディレクトリが分かれています（`/stp/`, `/companies/`, `/admin/` 等）。これは自然に作業領域の分離になっています。

### 将来的な構造の選択肢

| 方式 | 概要 | 適したフェーズ |
|---|---|---|
| **モノレポ + ディレクトリ分離（推奨）** | 1リポジトリ内で `packages/core`, `packages/stp`, `packages/custom-a` のように分離 | 今〜中期 |
| **npm パッケージ化** | コア機能をnpmパッケージとして切り出し、各社プロジェクトがdependencyとして利用 | 中期〜 |
| **プラグインアーキテクチャ** | コアにプラグインを差し込む形式（設定ファイルで有効/無効を切り替え） | 長期 |

### モノレポ方式の具体的な構成イメージ

```
stella-crm/
├── packages/
│   ├── core/          # Aチーム: 認証、権限、共通UI、DB基盤
│   ├── stp/           # Bチーム: STP事業固有機能
│   ├── accounting/    # 会計モジュール
│   └── custom-x/     # 個社カスタマイズ
├── apps/
│   └── web/           # Next.jsアプリ（各パッケージを統合）
```

### 個社差分を吸収する方法

- **設定ファイル：** 項目の表示/非表示、ラベル名の変更、マスタデータの初期値
- **フィーチャーフラグ：** 機能のON/OFF
- **カスタムフィールド機能：** 顧客がUI上から項目を追加

ただし、これは**他社に卸す場合の話**です。③は①②の結論次第で必要性が変わります。現時点でStella社向けの開発を続ける場合は、今のディレクトリ構成のまま、ロジックの関数化を進めておくだけで十分です。

---

## ④ 推奨アーキテクチャ（率直な意見）

**結論：マルチテナント設計は不要。今はStella社向けの完成に集中すべきです。**

| 質問 | 回答 |
|---|---|
| 今の段階でマルチテナント前提に作るべきか | **いいえ。** 各社のビジネスモデルが異なるため、マルチテナント化のメリットがない |
| 一旦シングルテナントで作って後から分離可能か | **はい。** ただし「分離」ではなく「技術資産を再利用して別システムを開発」という形になる |
| 最も拡張性が高く初期コストが重くない設計は | **今の設計のままStella社向けに完成させ、コードの整理だけしておく** |

### 今やっておくべき「低コストな準備」

| 準備内容 | 工数 | 効果 |
|---|---|---|
| ビジネスロジックの関数化 | 既に部分的に実施済み | ロジックの差し替えを容易にする |
| マスタデータのDB管理 | 既に実施済み | 設定変更でカスタマイズ可能 |
| ハードコードの排除 | 0.5人月 | 事業固有の値を定数/設定に切り出す |
| Prismaスキーマの命名整理 | 0.5人月 | `Stp`プレフィックスを整理し、汎用的な命名に |

**これらは「外販しなくても価値がある」改善であり、無駄になりません。**

### もし将来的に外販するなら

「パッケージ製品を売る」ではなく、**「Stella社で培った技術基盤・設計ノウハウを使って、他社向けシステムを効率的に受託開発する」**という形が最も現実的です。

その場合の判断基準：

1. Stella社で3〜6ヶ月の実運用実績ができた
2. 「この技術基盤で他社のシステムも作れる」という手応えが出た
3. 最初のターゲット顧客が具体的に決まった

この段階で、共通基盤の切り出し（1〜2人月）を行い、個別開発の効率を上げていく流れになります。
